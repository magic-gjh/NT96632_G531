//This source code is generated by UI Designer Studio.

#include "UIFramework.h"
#include "UIFrameworkExt.h"
#include "UIGraphics.h"
#include "NVTToolCommand.h"
#include "SysCfg.h"
#include "PhotoTsk.h"
#include "PhotoDisTsk.h"
#include "FileSysTsk.h"
#include "PrimaryTsk.h"
#include "KeyScanTsk.h"
#include "UIFlowWndCommonAPI.h"
#include "UIMenuWndMovieVideo.h"
#include "UIMenuWndPhotoQuickSetting.h"
#include "UIPhotoObj.h"
#include "UIMovieObj.h"
#include "UISystemObj.h"
#include "UISystemStatusSettings.h"
#include "UIFlowWndMovieRes.c"
#include "UIFlowWndMovie.h"
#include "UIFlowWndWrnMsg.h"
#include "rtc.h"
#if (_MOVIE_PIM_MODE_ == ENABLE)
#include "RawEncApi.h"
#endif

//---------------------UIFlowWndMovieCtrl Control List---------------------------
CTRL_LIST_BEGIN(UIFlowWndMovie)
CTRL_LIST_ITEM(UIFlowWndMovie_Static_camera)
CTRL_LIST_ITEM(UIFlowWndMovie_Status_ae)
CTRL_LIST_ITEM(UIFlowWndMovie_Status_awb)
CTRL_LIST_ITEM(UIFlowWndMovie_Status_battery)
CTRL_LIST_ITEM(UIFlowWndMovie_Panel)
CTRL_LIST_ITEM(UIFlowWndMovie_Static_time)
CTRL_LIST_ITEM(UIFlowWndMovie_Static_maxtime)
CTRL_LIST_ITEM(UIFlowWndMovie_Static_resolution)
CTRL_LIST_ITEM(UIFlowWndMovie_Zoom_Static)
CTRL_LIST_ITEM(UIFlowWnd_Histo)
CTRL_LIST_ITEM(UIFlowWndMovie_YMD_Static)
CTRL_LIST_ITEM(UIFlowWndMovie_HMS_Static)
CTRL_LIST_ITEM(UIFlowWndMovie_Macro_Status)
CTRL_LIST_ITEM(UIFlowWndMovie_StatusICN_Storage)
CTRL_LIST_ITEM(UIFlowWndMovie_StaticIcon_PIM)
CTRL_LIST_ITEM(UIFlowWndMovie_StatusIcon_DIS)
CTRL_LIST_END

//----------------------UIFlowWndMovieCtrl Event---------------------------
INT32 UIFlowWndMovie_OnOpen(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnClose(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnKeyMenu(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnKeyUp(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnKeyDown(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnKeyLeft(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnKeyRight(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnKeyEnter(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnKeyShutter2(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnKeyZoomin(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnKeyZoomout(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnKeyMode(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnKeyPlayback(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnBattery(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnChildClose(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnMovieFinish(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnMovieOneSec(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnMovieFull(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnMovieWrError(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnOZoomStepChange(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnDZoomStepChange(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnStorageChange(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnMacroChange(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnTimer(VControl *, UINT32, UINT32 *);
EVENT_BEGIN(UIFlowWndMovie)
EVENT_ITEM(NVTEVT_OPEN_WINDOW,UIFlowWndMovie_OnOpen)
EVENT_ITEM(NVTEVT_CLOSE_WINDOW,UIFlowWndMovie_OnClose)
EVENT_ITEM(NVTEVT_KEY_MENU,UIFlowWndMovie_OnKeyMenu)
EVENT_ITEM(NVTEVT_KEY_UP,UIFlowWndMovie_OnKeyUp)
EVENT_ITEM(NVTEVT_KEY_DOWN,UIFlowWndMovie_OnKeyDown)
EVENT_ITEM(NVTEVT_KEY_LEFT,UIFlowWndMovie_OnKeyLeft)
EVENT_ITEM(NVTEVT_KEY_RIGHT,UIFlowWndMovie_OnKeyRight)
EVENT_ITEM(NVTEVT_KEY_ENTER,UIFlowWndMovie_OnKeyEnter)
EVENT_ITEM(NVTEVT_KEY_SHUTTER2,UIFlowWndMovie_OnKeyShutter2)
EVENT_ITEM(NVTEVT_KEY_ZOOMIN,UIFlowWndMovie_OnKeyZoomin)
EVENT_ITEM(NVTEVT_KEY_ZOOMOUT,UIFlowWndMovie_OnKeyZoomout)
EVENT_ITEM(NVTEVT_KEY_MODE,UIFlowWndMovie_OnKeyMode)
EVENT_ITEM(NVTEVT_KEY_PLAYBACK,UIFlowWndMovie_OnKeyPlayback)
EVENT_ITEM(NVTEVT_BATTERY,UIFlowWndMovie_OnBattery)
EVENT_ITEM(NVTEVT_CHILD_CLOSE,UIFlowWndMovie_OnChildClose)
EVENT_ITEM(NVTEVT_CB_MOVIE_FINISH,UIFlowWndMovie_OnMovieFinish)
EVENT_ITEM(NVTEVT_CB_MOVIE_ONE_SEC,UIFlowWndMovie_OnMovieOneSec)
EVENT_ITEM(NVTEVT_CB_MOVIE_FULL,UIFlowWndMovie_OnMovieFull)
EVENT_ITEM(NVTEVT_CB_MOVIE_WR_ERROR,UIFlowWndMovie_OnMovieWrError)
EVENT_ITEM(NVTEVT_CB_OZOOMSTEPCHG,UIFlowWndMovie_OnOZoomStepChange)
EVENT_ITEM(NVTEVT_CB_DZOOMSTEPCHG,UIFlowWndMovie_OnDZoomStepChange)
EVENT_ITEM(NVTEVT_STORAGE_CHANGE,UIFlowWndMovie_OnStorageChange)
EVENT_ITEM(NVTEVT_MACRO_CHANGE,UIFlowWndMovie_OnMacroChange)
EVENT_ITEM(NVTEVT_TIMER,UIFlowWndMovie_OnTimer)
EVENT_END

//------------------------------------------------------------
#define _UIRECAVI_DBG_MSG_              0
#if _UIRECAVI_DBG_MSG_
    #include "Debug.h"
    #define DbgMsg_UIRecAvi(msg)        debug_msg msg
    #define DbgCode_UIRecAvi(x)         x
#else
    #define DbgMsg_UIRecAvi(msg)
    #define DbgCode_UIRecAvi(x)
#endif

// Movie mode key mask
#define MOVIE_KEY_PRESS_MASK        (FLGKEY_KEY_MASK_DEFAULT)
//#define MOVIE_KEY_RELEASE_MASK      (FLGKEY_ZOOMIN | FLGKEY_ZOOMOUT)
#define MOVIE_KEY_RELEASE_MASK      (FLGKEY_ZOOMIN | FLGKEY_ZOOMOUT | FLGKEY_UP | FLGKEY_DOWN)

//#define MOVIERECORD_KEY_PRESS_MASK  (FLGKEY_ZOOMIN | FLGKEY_ZOOMOUT | FLGKEY_SHUTTER2 | FLGKEY_MODE | FLGKEY_RIGHT)
#define MOVIERECORD_KEY_PRESS_MASK  (FLGKEY_ZOOMIN | FLGKEY_ZOOMOUT | FLGKEY_SHUTTER2 | FLGKEY_MODE | FLGKEY_UP | FLGKEY_DOWN | FLGKEY_RIGHT | FLGKEY_ENTER)
//#define MOVIEERR_KEY_PRESS_MASK     (FLGKEY_MENU|FLGKEY_UP|FLGKEY_DOWN|FLGKEY_LEFT|FLGKEY_RIGHT|FLGKEY_MODE|FLGKEY_PLAYBACK)
#define TIMER_ONE_SEC               1000
//------------------------------------------------------------
CHAR    gUIAviRecMaxTimeStr[20] = {0};
CHAR    gUIAviRecCurTimeStr[20] = {0};

BOOL    gUIAviIsRecording = FALSE;
BOOL    gUIAviStoreFull = FALSE;
UINT32  gUIAviRecMaxTime = 0;
UINT32  gUIAviRecCurTime = 0;
UINT32  gUIAviSelfTimerSec = 0;
UINT32  gUIAviTimerID = NULL_TIMER;

// MOVIE mode child window mode
typedef enum
{
    MOVIE_CHILD_WND_NULL        = 0,
    MOVIE_CHILD_WND_MENU,
    MOVIE_CHILD_WND_QUICKSETTING,
    MOVIE_CHILD_WND_WRNMSG
} MOVIE_CHILD_WND;

static UINT32   g_uiChildWndMode = MOVIE_CHILD_WND_NULL;
static UINT32   gHistogram_show_timer = NULL_TIMER;
static UINT32   g_uiTimeTimerID = NULL_TIMER;
static CHAR resolution_Buf[MOVIE_SIZE_SETTING_MAX][10]=
{
    "1080P",
    "720P",
    "WVGA",
    "QVGA"
};
static CHAR        date_str[20];
static CHAR        time_str[20];
static UINT32 g_uiMaskKeyPress      = MOVIE_KEY_PRESS_MASK;
static UINT32 g_uiMaskKeyRelease    = MOVIE_KEY_RELEASE_MASK;
static BOOL   g_bPIMReady           = FALSE;

#if 0
static CHAR dzoom_Buf[MOVIE_DZOOM_SETTING_MAX][10]=
{
    "*1.0",
    "*2.0",
    "*3.0",
    "*4.0"
};
#endif

void UIFlowWndMovie_SetPIMReady(BOOL bReady)
{
    g_bPIMReady = bReady;
}

BOOL UIFlowWndMovie_CheckPIMReady(void)
{
    return g_bPIMReady;
}

void UIFlowWndMovie_DrawPIM(BOOL bDraw)
{
    UxCtrl_SetShow(&UIFlowWndMovie_StaticIcon_PIMCtrl, bDraw);
}

static void FlowMovie_DrawMaxRecTime(BOOL bDraw)
{
    memset((void *)gUIAviRecMaxTimeStr, 0, sizeof(gUIAviRecMaxTimeStr));
    gUIAviRecMaxTime = UIRecMovie_GetData(RECMOVIE_MAXSECOND);
    DbgMsg_UIRecAvi(("DrawMaxRecTime:bDraw=%d,gUIAviRecMaxTime=%d\r\n", bDraw, gUIAviRecMaxTime));
    if (gUIAviRecMaxTime <= 1)
    {
        DbgMsg_UIRecAvi(("Storage Full\r\n"));
        gUIAviStoreFull = TRUE;
        gUIAviRecMaxTime = 0;
    }
    else if (gUIAviRecMaxTime > 86399)
    {   ///23:59:59
        DbgMsg_UIRecAvi(("Max-Rec-Time=%d > 23:59:59\r\n", gUIAviRecMaxTime));
        gUIAviRecMaxTime = 86399;
    }
    sprintf(gUIAviRecMaxTimeStr,"%02d:%02d:%02d", gUIAviRecMaxTime/3600,(gUIAviRecMaxTime%3600)/60, (gUIAviRecMaxTime%3600)%60);
    UxStatic_SetData(&UIFlowWndMovie_Static_maxtimeCtrl,STATIC_VALUE,Txt_Pointer(gUIAviRecMaxTimeStr));
    UxCtrl_SetShow(&UIFlowWndMovie_Static_maxtimeCtrl, bDraw);
    UxCtrl_SetShow(&UIFlowWndMovie_Static_timeCtrl, !bDraw);
}
static void FlowMovie_DrawRecTime(BOOL bDraw, UINT32 recTime)
{
    if(gUIAviIsRecording == TRUE)
    {
        gUIAviRecCurTime = recTime;
        memset((void *)gUIAviRecCurTimeStr, 0, sizeof(gUIAviRecCurTimeStr));
        sprintf(gUIAviRecCurTimeStr,"%02d:%02d:%02d", recTime/3600,(recTime%3600)/60, (recTime%3600)%60);
        DbgMsg_UIRecAvi(("#%s \r\n",gUIAviRecCurTimeStr));
        UxStatic_SetData(&UIFlowWndMovie_Static_timeCtrl,STATIC_VALUE,Txt_Pointer(gUIAviRecCurTimeStr));
        UxCtrl_SetShow(&UIFlowWndMovie_Static_timeCtrl, bDraw);
        UxCtrl_SetShow(&UIFlowWndMovie_Static_maxtimeCtrl, !bDraw);
    }
}
static void FlowMovie_StopRec(BOOL stopLib)
{
    KeyScan_SetKeyMask(KEYSCAN_KEYMODE_PRESS, FLGKEY_KEY_MASK_NULL);
    Ux_FlushEvent();

    UxCtrl_SetShow(&UIFlowWndMovie_PanelCtrl,FALSE);

    if (stopLib == TRUE)
    {
        Ux_SendEvent(&UIMovieObjCtrl,NVTEVT_STOP_RECAVI,NULL);
    }
    else
    {
        KeyScan_EnableAutoPoweroff(TRUE);
        KeyScan_EnableUSBDet(TRUE);
        gUIAviIsRecording = FALSE;
        FlowMovie_DrawMaxRecTime(TRUE);
        KeyScan_SetKeyMask(KEYSCAN_KEYMODE_PRESS, FLGKEY_KEY_MASK_DEFAULT);
    }
}

static void FlowMovie_StopDownTimer(void)
{
    if (gUIAviTimerID != NULL_TIMER)
    {
        KeyScan_stopTimer(&gUIAviTimerID);
        gUIAviTimerID = NULL_TIMER;
    }
    gUIAviSelfTimerSec = 0;
}

static void FlowMovie_StartRec(void)
{
    if (gUIAviSelfTimerSec == 0)
    {
        gUIAviIsRecording = TRUE;
        gUIAviRecCurTime = 0;
        UIFlowWndMovie_SetPIMReady(TRUE);
        KeyScan_SetKeyMask(KEYSCAN_KEYMODE_PRESS, FLGKEY_KEY_MASK_NULL);
        Ux_FlushEvent();
        Ux_SendEvent(&UIMovieObjCtrl,NVTEVT_START_RECAVI,NULL);
        KeyScan_EnableAutoPoweroff(FALSE); //disable auto poweroff,while recording
        KeyScan_EnableUSBDet(FALSE);       //disable USB detect,while recording
        KeyScan_SetKeyMask(KEYSCAN_KEYMODE_PRESS, MOVIERECORD_KEY_PRESS_MASK);
    }
    else
    {
        debug_err(("FlowMovie_StartRec: Not yet,gUIAviSelfTimerSec=%d\r\n", gUIAviSelfTimerSec));
    }
}

static BOOL FlowMovie_IsEnvErr(void)
{
    UINT32  maskKey = (FLGKEY_MENU|FLGKEY_UP|FLGKEY_DOWN|FLGKEY_LEFT|FLGKEY_RIGHT|FLGKEY_ENTER);//FLGKEY_UP=MENU,FLGKEY_DOWN=MODE
    BOOL    retV = FALSE;
    UINT32  uiMsg;
    if(UI_Validate_Storage(STORAGE_CHECK_ERROR, NULL) == FALSE)
    {
        DbgMsg_UIRecAvi(("#IntrMem Full \r\n"));
        g_uiChildWndMode = MOVIE_CHILD_WND_WRNMSG;
        #if ((_PSTOREDEVICE_ == _PSTOREDEVICE_SPIFLASH_) && (_RAM_DISK_ == DISABLE))
        uiMsg = (GetCardStatus() == CARD_REMOVED)? FLOWWRNMSG_ISSUE_NO_CARD : FLOWWRNMSG_ISSUE_CARD_ERR;
        #else
        uiMsg = (GetCardStatus() == CARD_REMOVED)? FLOWWRNMSG_ISSUE_MEM_ERR : FLOWWRNMSG_ISSUE_CARD_ERR;
        #endif
        Ux_OpenWindow(&UIFlowWndWrnMsgCtrl,2,uiMsg,FLOWWRNMSG_TIMER_KEEP);
        retV = TRUE;
        return retV;
    }
    if(UI_Validate_Storage(STORAGE_CHECK_FULL, &(gUIAviRecMaxTime)) == FALSE)
    {
        gUIAviStoreFull = TRUE;
        gUIAviRecMaxTime = 0;
        maskKey |= FLGKEY_PLAYBACK;
        DbgMsg_UIRecAvi(("#Card Full \r\n"));

        if (GetCardStatus() == CARD_REMOVED)
        {
            g_uiChildWndMode = MOVIE_CHILD_WND_WRNMSG;
            Ux_OpenWindow(&UIFlowWndWrnMsgCtrl,2,FLOWWRNMSG_ISSUE_NO_CARD,FLOWWRNMSG_TIMER_2SEC);
        }
        else
        {
            g_uiChildWndMode = MOVIE_CHILD_WND_WRNMSG;
            Ux_OpenWindow(&UIFlowWndWrnMsgCtrl,2,FLOWWRNMSG_ISSUE_CARD_FULL,FLOWWRNMSG_TIMER_2SEC);
        }
        retV = TRUE;
        return retV;
    }
    if(UI_Validate_Storage(STORAGE_CHECK_LOCKED, NULL) == FALSE)
    {
        debug_err(("#Card locked\r\n"));
        DbgMsg_UIRecAvi(("#Card locked \r\n"));
        maskKey |= FLGKEY_PLAYBACK;
        g_uiChildWndMode = MOVIE_CHILD_WND_WRNMSG;
        Ux_OpenWindow(&UIFlowWndWrnMsgCtrl,2,FLOWWRNMSG_ISSUE_CARD_LOCKED,FLOWWRNMSG_TIMER_2SEC);
        retV = TRUE;
        return retV;
    }
    retV = FALSE;
    return retV;
}

static BOOL FlowMovie_ChkDrawStoreFullFolderFull(void)
{
    if(UI_Validate_Storage(STORAGE_CHECK_FULL, &(gUIAviRecMaxTime)) == FALSE)
    {
        gUIAviStoreFull = TRUE;
        gUIAviRecMaxTime = UIRecMovie_GetData(RECMOVIE_MAXSECOND);
        if (GetCardStatus() == CARD_REMOVED)
        {
            DbgMsg_UIRecAvi(("@IntrMem Full \r\n"));
            g_uiChildWndMode = MOVIE_CHILD_WND_WRNMSG;
            Ux_OpenWindow(&UIFlowWndWrnMsgCtrl,2,FLOWWRNMSG_ISSUE_NO_CARD,FLOWWRNMSG_TIMER_KEEP);
            return TRUE;
        }
        else
        {
            DbgMsg_UIRecAvi(("@Card Full \r\n"));
            g_uiChildWndMode = MOVIE_CHILD_WND_WRNMSG;
            Ux_OpenWindow(&UIFlowWndWrnMsgCtrl,2,FLOWWRNMSG_ISSUE_CARD_FULL,FLOWWRNMSG_TIMER_KEEP);
            return TRUE;
        }
    }
    return FALSE;
}

static void UIFlowWndMovie_OnExePIM(void)
{
#if (_MOVIE_PIM_MODE_ == ENABLE)
    ACTFBADDR_PRAM gTempFBAddr;
    RAW_ENC_OBJ RawEncObj;

    UINT32  uiPoolAddr;
    UINT32  y1, cb1, cr1;
    UINT8   status;
    UINT32  sec, unsafe;

    if (!UIFlowWndMovie_CheckPIMReady())
        return;

    debug_msg("encode one...\r\n");
    sec = MediaRec_Disk2Second();
    unsafe = MediaRec_CheckUnsavedFileBlocks();
    //debug_msg("recording sec=%d, before RAWENC\r\n", sec);
    if ((sec > 3)&&(unsafe == 0))
    {
        UIFlowWndMovie_SetPIMReady(FALSE);
        UIFlowWndMovie_DrawPIM(TRUE);
        //#NT#2010/09/06#Meg Lin -begin
        //GetActImgFBAddr_Path2(&gTempFBAddr);
        MediaRec_GetActVideoAddr(&gTempFBAddr);
        //#NT#2010/09/06#Meg Lin -end

        //debug_msg("y=0x%lx, 2=0x%lx, 3=0x%lx!\r\n", gTempFBAddr.y_addr, gTempFBAddr.cb_addr, gTempFBAddr.cr_addr);
        RawEnc_SetRawAddr2Encode(gTempFBAddr.y_addr, gTempFBAddr.cb_addr, gTempFBAddr.cr_addr, gTempFBAddr.SrcYLineOffset);//2010/03/19 Meg Lin
    }
    else
    {
        if (unsafe)
        {
            debug_err(("unsafe to take picture !\r\n"));
        }
        else
        {
            debug_err(("no space to encode RAW !\r\n"));
        }
    }
#endif
}

static INT32 UIFlowWndMovie_OnExeZoomIn(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    UINT32  state;

    if (paramNum > 0)
        state = *paramArray;
    debug_err(("[UIFlowWndMovie_OnExeZoomIn][%d]\n\r",*paramArray));
    switch(state)
    {
    case NVTEVT_KEY_PRESS:
        Ux_SendEvent(&UIPhotoObjCtrl,NVTEVT_ZOOMIN,0);
        break;
    case NVTEVT_KEY_RELEASE:
        Ux_SendEvent(&UIPhotoObjCtrl,NVTEVT_ZOOMSTOP,0);
        break;
    }
    return NVTEVT_PASS;
}

static INT32 UIFlowWndMovie_OnExeZoomOut(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    UINT32  state;

    if (paramNum > 0)
        state = *paramArray;
    debug_err(("[UIFlowWndMovie_OnExeZoomOut][%d]\n\r",*paramArray));
    switch(state)
    {
    case NVTEVT_KEY_PRESS:
        Ux_SendEvent(&UIPhotoObjCtrl,NVTEVT_ZOOMOUT,0);
        break;
    case NVTEVT_KEY_RELEASE:
        Ux_SendEvent(&UIPhotoObjCtrl,NVTEVT_ZOOMSTOP,0);
        break;
    }
    return NVTEVT_PASS;
}

static INT32 UIFlowWndMovie_OnExeRecord(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    if (gUIAviIsRecording == TRUE)
    {
        if(gUIAviRecCurTime >= 1)
        {
            DbgMsg_UIRecAvi(("Stop Rec Avi, Save Avi File\r\n"));
            FlowMovie_StopRec(TRUE);
        }
    }
    else
    {
        if (FlowMovie_IsEnvErr() == TRUE)
        {
            return NVTEVT_CONSUME;
        }
        if (gUIAviTimerID != NULL_TIMER)
        {
            DbgMsg_UIRecAvi(("Shutter2 during Count-Down,Stop Self-Timer\r\n"));
            FlowMovie_StopDownTimer();
            return NVTEVT_CONSUME;
        }
        UxCtrl_SetShow(&UIFlowWndMovie_PanelCtrl,TRUE);
        gUIAviSelfTimerSec = 0; ///0 seconds
        gUIAviStoreFull = FALSE;
        DbgMsg_UIRecAvi(("Start Rec Avi:d=%d,f=%d\r\n",Get_FilesysDirId(),Get_FilesysFileId()));

        FlowMovie_StartRec();
    }
    return NVTEVT_CONSUME;
}

static void UIFlowWndMovie_Update_Info(void)
{
    UINT32  uiMsg,uiFreePicNum;
    INT32   ev_icon_index,wb_icon_index;
    UINT32  macro_state;
    AlgMsgInfo *pAlgMsgInfo = Get_AlgMsgInfo();


    switch(Get_EVIndex())
    {
        case EV_N20:
            ev_icon_index = UIFlowWndMovie_Status_ae_ICON_EV_M2P0;
            break;
        case EV_N16:
            ev_icon_index = UIFlowWndMovie_Status_ae_ICON_EV_M1P6;
            break;
        case EV_N13:
            ev_icon_index = UIFlowWndMovie_Status_ae_ICON_EV_M1P3;
            break;
        case EV_N10:
            ev_icon_index = UIFlowWndMovie_Status_ae_ICON_EV_M1P0;
            break;
        case EV_N06:
            ev_icon_index = UIFlowWndMovie_Status_ae_ICON_EV_M0P6;
            break;
        case EV_N03:
            ev_icon_index = UIFlowWndMovie_Status_ae_ICON_EV_M0P3;
            break;
        case EV_00:
            ev_icon_index = UIFlowWndMovie_Status_ae_ICON_EV_P0P0;
            break;
        case EV_P03:
            ev_icon_index = UIFlowWndMovie_Status_ae_ICON_EV_P0P3;
            break;
        case EV_P06:
            ev_icon_index = UIFlowWndMovie_Status_ae_ICON_EV_P0P6;
            break;
        case EV_P10:
            ev_icon_index = UIFlowWndMovie_Status_ae_ICON_EV_P1P0;
            break;
        case EV_P13:
            ev_icon_index = UIFlowWndMovie_Status_ae_ICON_EV_P1P3;
            break;
        case EV_P16:
            ev_icon_index = UIFlowWndMovie_Status_ae_ICON_EV_P1P6;
            break;
        case EV_P20:
            ev_icon_index = UIFlowWndMovie_Status_ae_ICON_EV_P2P0;
            break;
    }
    switch(Get_WBIndex())
    {
        case WB_AUTO:
            wb_icon_index = UIFlowWndMovie_Status_awb_ICON_WB_AUTO;
            break;
        case WB_TUNGSTEN:
            wb_icon_index = UIFlowWndMovie_Status_awb_ICON_WB_TUNGSTEN;
            break;
        case WB_FLUORESCENT1:
            wb_icon_index = UIFlowWndMovie_Status_awb_ICON_WB_FLUORESCENT;
            break;
        case WB_DAYLIGHT:
            wb_icon_index = UIFlowWndMovie_Status_awb_ICON_WB_DAYLIGHT;
            break;
        case WB_CLOUDY:
            wb_icon_index = UIFlowWndMovie_Status_awb_ICON_WB_CLOUDY;
            break;
    }
    UxState_SetData(&UIFlowWndMovie_Status_aeCtrl,STATE_CURITEM,ev_icon_index);
    UxState_SetData(&UIFlowWndMovie_Status_awbCtrl,STATE_CURITEM,wb_icon_index);
    UxStatic_SetData(&UIFlowWndMovie_Static_resolutionCtrl,STATIC_VALUE,Txt_Pointer(resolution_Buf[Get_MovieSizeIndex()]));
    UxState_SetData(&UIFlowWndMovie_StatusIcon_DISCtrl,STATE_CURITEM,Get_MovieDISIndex());

    //UxStatic_SetData(&UIFlowWndMovie_Zoom_StaticCtrl,STATIC_VALUE,Txt_Pointer(dzoom_Buf[Get_UIDzoomIndex()]));
    /* Update digital zoom ratio OSD string */
    UxStatic_SetData(&UIFlowWndMovie_Zoom_StaticCtrl,STATIC_VALUE,Txt_Pointer(Get_DZoomRatioString(pAlgMsgInfo)));

    if(pAlgMsgInfo->DzoomIndex > UI_DZOOM_IDX_MIN)
        UxCtrl_SetShow(&UIFlowWndMovie_Zoom_StaticCtrl,TRUE);
    else
        UxCtrl_SetShow(&UIFlowWndMovie_Zoom_StaticCtrl,FALSE);

    UxState_SetData(&UIFlowWndMovie_Status_batteryCtrl,STATE_CURITEM,GetBatteryLevel());

    macro_state = Get_MacroIndex();
    switch(macro_state)
    {
    case TRUE:
        UxState_SetData(&UIFlowWndMovie_Macro_StatusCtrl,STATE_CURITEM,UIFlowWndMovie_Macro_Status_ICON_MACRO);
        break;
    case FALSE:
//        UxState_SetData(&UIFlowWndMovie_Macro_StatusCtrl,STATE_CURITEM,UIFlowWndMovie_Macro_Status_ICON_LANDSCAPE);
        UxState_SetData(&UIFlowWndMovie_Macro_StatusCtrl,STATE_CURITEM,UIFlowWndMovie_Macro_Status_ICONID_NULL);
        break;
    }

    UxState_SetData(&UIFlowWndMovie_StatusICN_StorageCtrl,STATE_CURITEM,(GetCardStatus() == CARD_REMOVED)? UIFlowWndMovie_StatusICN_Storage_ICON_INTERNAL_FLASH : UIFlowWndMovie_StatusICN_Storage_ICON_SD_CARD);

#if 1
    UxCtrl_SetShow(&UIFlowWndMovie_YMD_StaticCtrl,FALSE);
    UxCtrl_SetShow(&UIFlowWndMovie_HMS_StaticCtrl,FALSE);
#else
//update time
{
    RTC_DATE    Date;
    RTC_TIME    Time;
    Date = rtc_getDate();
    Time = rtc_getTime();
    sprintf(date_str,"%04d/%02d/%02d",Date.s.year,Date.s.month,Date.s.day);
    sprintf(time_str,"%02d:%02d:%02d",Time.s.hour,Time.s.minute,Time.s.second);
 //   debug_err(("date_str=%s\n\r",date_str));
 //   debug_err(("time_str=%s\n\r",time_str));
    UxStatic_SetData(&UIFlowWndMovie_YMD_StaticCtrl,STATIC_VALUE,Txt_Pointer(date_str));
    UxStatic_SetData(&UIFlowWndMovie_HMS_StaticCtrl,STATIC_VALUE,Txt_Pointer(time_str));

    switch(Get_DisplayIndex())
    {
        case DISPLAY_OFF://disappear.
            UxCtrl_SetShow(&UIFlowWndMovie_YMD_StaticCtrl,FALSE);
            UxCtrl_SetShow(&UIFlowWndMovie_HMS_StaticCtrl,FALSE);
            if(g_uiTimeTimerID != NULL_TIMER)
                KeyScan_stopTimer(&g_uiTimeTimerID);
            break;
        case DISPLAY_NORMAL://display normal
        case DISPLAY_ALL://displayall
            UxCtrl_SetShow(&UIFlowWndMovie_YMD_StaticCtrl,TRUE);
            UxCtrl_SetShow(&UIFlowWndMovie_HMS_StaticCtrl,TRUE);
            if(g_uiTimeTimerID == NULL_TIMER)
                g_uiTimeTimerID = KeyScan_startTimer(TIMER_ONE_SEC, NVTEVT_1SEC_TIMER, CONTINUE);
            break;
    }
}
#endif

#if 1
    switch(Get_DisplayIndex())
    {
    case DISPLAY_OFF://disappear.
        UxCtrl_SetShow(&UIFlowWnd_HistoCtrl,FALSE);
        UxCtrl_SetShow(&UIFlowWndMovie_Static_cameraCtrl,FALSE);
        UxCtrl_SetShow(&UIFlowWndMovie_Static_maxtimeCtrl,FALSE);
        UxCtrl_SetShow(&UIFlowWndMovie_Status_aeCtrl,FALSE);
        UxCtrl_SetShow(&UIFlowWndMovie_Static_resolutionCtrl,FALSE);
        UxCtrl_SetShow(&UIFlowWndMovie_Status_awbCtrl,FALSE);
        UxCtrl_SetShow(&UIFlowWndMovie_Zoom_StaticCtrl,FALSE);
        UxCtrl_SetShow(&UIFlowWndMovie_Status_batteryCtrl,FALSE);
        UxCtrl_SetShow(&UIFlowWndMovie_YMD_StaticCtrl,FALSE);
        UxCtrl_SetShow(&UIFlowWndMovie_HMS_StaticCtrl,FALSE);
        UxCtrl_SetShow(&UIFlowWndMovie_Macro_StatusCtrl,FALSE);
        UxCtrl_SetShow(&UIFlowWndMovie_StatusICN_StorageCtrl,FALSE);
        break;
    case DISPLAY_NORMAL://display normal
        UxCtrl_SetShow(&UIFlowWnd_HistoCtrl,FALSE);
        UxCtrl_SetShow(&UIFlowWndMovie_Static_cameraCtrl,TRUE);
        if(gUIAviIsRecording != TRUE)
        {
            UxCtrl_SetShow(&UIFlowWndMovie_Static_maxtimeCtrl,TRUE);
            FlowMovie_DrawMaxRecTime(TRUE);
        }
        if(Get_EVIndex() == EV_00)//HDV5D4 spec
            UxCtrl_SetShow(&UIFlowWndMovie_Status_aeCtrl,FALSE);
        else
            UxCtrl_SetShow(&UIFlowWndMovie_Status_aeCtrl,TRUE);

        UxCtrl_SetShow(&UIFlowWndMovie_Static_resolutionCtrl,TRUE);
        UxCtrl_SetShow(&UIFlowWndMovie_Status_awbCtrl,FALSE);
        if(pAlgMsgInfo->DzoomIndex > UI_DZOOM_IDX_MIN)
            UxCtrl_SetShow(&UIFlowWndMovie_Zoom_StaticCtrl,TRUE);
        else
            UxCtrl_SetShow(&UIFlowWndMovie_Zoom_StaticCtrl,FALSE);
        UxCtrl_SetShow(&UIFlowWndMovie_Status_batteryCtrl,FALSE);
        UxCtrl_SetShow(&UIFlowWndMovie_YMD_StaticCtrl,FALSE);
        UxCtrl_SetShow(&UIFlowWndMovie_HMS_StaticCtrl,FALSE);
        UxCtrl_SetShow(&UIFlowWndMovie_Macro_StatusCtrl,TRUE);
        UxCtrl_SetShow(&UIFlowWndMovie_StatusICN_StorageCtrl,TRUE);
        break;
    case DISPLAY_ALL://displayall
        UxCtrl_SetShow(&UIFlowWnd_HistoCtrl,FALSE);
        UxCtrl_SetShow(&UIFlowWndMovie_Static_cameraCtrl,TRUE);
        if(gUIAviIsRecording != TRUE)
        {
            UxCtrl_SetShow(&UIFlowWndMovie_Static_maxtimeCtrl,TRUE);
            FlowMovie_DrawMaxRecTime(TRUE);
        }
        if(Get_EVIndex() == EV_00)//HDV5D4 spec
            UxCtrl_SetShow(&UIFlowWndMovie_Status_aeCtrl,FALSE);
        else
            UxCtrl_SetShow(&UIFlowWndMovie_Status_aeCtrl,TRUE);

        UxCtrl_SetShow(&UIFlowWndMovie_Static_resolutionCtrl,TRUE);
        UxCtrl_SetShow(&UIFlowWndMovie_Status_awbCtrl,FALSE);//spec does not need this icon
        if(pAlgMsgInfo->DzoomIndex > UI_DZOOM_IDX_MIN)
            UxCtrl_SetShow(&UIFlowWndMovie_Zoom_StaticCtrl,TRUE);
        else
            UxCtrl_SetShow(&UIFlowWndMovie_Zoom_StaticCtrl,FALSE);
        UxCtrl_SetShow(&UIFlowWndMovie_Status_batteryCtrl,FALSE);
        UxCtrl_SetShow(&UIFlowWndMovie_YMD_StaticCtrl,FALSE);
        UxCtrl_SetShow(&UIFlowWndMovie_HMS_StaticCtrl,FALSE);
        UxCtrl_SetShow(&UIFlowWndMovie_Macro_StatusCtrl,TRUE);
        UxCtrl_SetShow(&UIFlowWndMovie_StatusICN_StorageCtrl,TRUE);
        break;
    }
#endif

    /* Validate storage */
    /* Not Validating storage while movie recording */
    if (gUIAviIsRecording != TRUE)
        {
            /* Validate storage */
        if(UI_Validate_Storage(STORAGE_CHECK_ERROR, NULL) == FALSE)
        {
            #if ((_PSTOREDEVICE_ == _PSTOREDEVICE_SPIFLASH_) && (_RAM_DISK_ == DISABLE))
            uiMsg = (GetCardStatus() == CARD_REMOVED)? FLOWWRNMSG_ISSUE_NO_CARD : FLOWWRNMSG_ISSUE_CARD_ERR;
            #else
            uiMsg = (GetCardStatus() == CARD_REMOVED)? FLOWWRNMSG_ISSUE_MEM_ERR : FLOWWRNMSG_ISSUE_CARD_ERR;
            #endif
            g_uiChildWndMode = MOVIE_CHILD_WND_WRNMSG;
            Ux_OpenWindow(&UIFlowWndWrnMsgCtrl,2,uiMsg,FLOWWRNMSG_TIMER_KEEP);
            return;
        }
        else if(UI_Validate_Storage(STORAGE_CHECK_LOCKED, NULL) == FALSE)
        {
            g_uiChildWndMode = MOVIE_CHILD_WND_WRNMSG;
            Ux_OpenWindow(&UIFlowWndWrnMsgCtrl,2,FLOWWRNMSG_ISSUE_CARD_LOCKED,FLOWWRNMSG_TIMER_KEEP);
            return;
        }
        else if(UI_Validate_Storage(STORAGE_CHECK_FULL, &uiFreePicNum) == FALSE)
        {
            uiMsg = (GetCardStatus() == CARD_REMOVED)? FLOWWRNMSG_ISSUE_NO_CARD : FLOWWRNMSG_ISSUE_CARD_FULL;
            g_uiChildWndMode = MOVIE_CHILD_WND_WRNMSG;
            if (GetCardStatus() == CARD_REMOVED)
            {
                DbgMsg_UIRecAvi(("@IntrMem Full \r\n"));
                g_uiChildWndMode = MOVIE_CHILD_WND_WRNMSG;
                Ux_OpenWindow(&UIFlowWndWrnMsgCtrl,2,FLOWWRNMSG_ISSUE_NO_CARD,FLOWWRNMSG_TIMER_KEEP);
                return;
            }
            else
            {
                DbgMsg_UIRecAvi(("@Card Full \r\n"));
                g_uiChildWndMode = MOVIE_CHILD_WND_WRNMSG;
                Ux_OpenWindow(&UIFlowWndWrnMsgCtrl,2,FLOWWRNMSG_ISSUE_CARD_FULL,FLOWWRNMSG_TIMER_KEEP);
                return;
            }
        }
    }
    return;
}
static void UIFlowWndMovie_Initparam()
{
    Ux_SendEvent(&UIPhotoObjCtrl,NVTEVT_EXE_EV,1,Get_EVIndex());
    Ux_SendEvent(&UIMovieObjCtrl,NVTEVT_EXE_COLOR,1,Get_MovieColorIndex());
    Ux_SendEvent(&UIMovieObjCtrl,NVTEVT_EXE_MOVIEDIS,1,Get_MovieDISIndex());
    Ux_SendEvent(&UIMovieObjCtrl,NVTEVT_EXE_DATEIMPRINT,1,Get_MovieDateImprintIndex());
    /* Video resolution setting must be set after other IQ settings */
    Ux_SendEvent(&UIMovieObjCtrl,NVTEVT_EXE_MOVIESIZE,1,Get_MovieSizeIndex());
}
INT32 UIFlowWndMovie_OnOpen(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    UIFlowWndMovie_Initparam();
    /* Init window key mask variables & set key and key released mask */
    g_uiMaskKeyPress = MOVIE_KEY_PRESS_MASK;
    g_uiMaskKeyRelease = MOVIE_KEY_RELEASE_MASK;
    KeyScan_SetKeyMask(KEYSCAN_KEYMODE_PRESS, g_uiMaskKeyPress);
    KeyScan_SetKeyMask(KEYSCAN_KEYMODE_RELEASE, g_uiMaskKeyRelease);
    UIFlowWndMovie_Update_Info();
    UxCtrl_SetShow(&UIFlowWndMovie_PanelCtrl,FALSE);
    UxCtrl_SetShow(&UIFlowWndMovie_StaticIcon_PIMCtrl, FALSE);


    Ux_DefaultEvent(pCtrl,NVTEVT_OPEN_WINDOW,paramNum,paramArray);
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnClose(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    if(g_uiTimeTimerID != NULL_TIMER)
        KeyScan_stopTimer(&g_uiTimeTimerID);
    if (gUIAviIsRecording == TRUE)
    {
        if(gUIAviRecCurTime <= 1)
        {
            TimerDelayMs(1000);
        }
        FlowMovie_StopRec(TRUE);
        Ux_SendEvent(&UIFlowWndMovieCtrl,NVTEVT_CB_MOVIE_FINISH,0);
    }

    KeyScan_SetKeyMask(KEYSCAN_KEYMODE_PRESS, FLGKEY_KEY_MASK_DEFAULT);
    KeyScan_SetKeyMask(KEYSCAN_KEYMODE_RELEASE, FLGKEY_KEY_REL_MASK_DEFAULT);

    Ux_DefaultEvent(pCtrl,NVTEVT_CLOSE_WINDOW,paramNum,paramArray);
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnKeyMenu(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    //Ux_DefaultEvent(pCtrl,NVTEVT_KEY_MENU,paramNum,paramArray);
    Ux_OpenWindow(&UIMenuWndMovieVideoCtrl,0);
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnKeyUp(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    return UIFlowWndMovie_OnExeZoomIn(pCtrl, paramNum, paramArray);
}
INT32 UIFlowWndMovie_OnKeyDown(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    return UIFlowWndMovie_OnExeZoomOut(pCtrl, paramNum, paramArray);
}
INT32 UIFlowWndMovie_OnKeyLeft(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnKeyRight(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    if (gUIAviIsRecording == FALSE)
    {
        Ux_DefaultEvent(pCtrl,NVTEVT_KEY_RIGHT,paramNum,paramArray);
        Ux_OpenWindow(&UIMenuWndPhotoQuickSettingCtrl,0);
    }
	else
    {
        UIFlowWndMovie_OnExePIM();
    }
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnKeyEnter(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    return UIFlowWndMovie_OnExeRecord(pCtrl, paramNum, paramArray);
}
INT32 UIFlowWndMovie_OnKeyShutter2(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    return UIFlowWndMovie_OnExeRecord(pCtrl, paramNum, paramArray);
}
INT32 UIFlowWndMovie_OnKeyZoomin(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    return UIFlowWndMovie_OnExeZoomIn(pCtrl, paramNum, paramArray);
}
INT32 UIFlowWndMovie_OnKeyZoomout(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    return UIFlowWndMovie_OnExeZoomOut(pCtrl, paramNum, paramArray);
}
INT32 UIFlowWndMovie_OnKeyMode(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    if (gUIAviIsRecording == TRUE)
    {
        FlowMovie_StopRec(TRUE);
        Ux_SendEvent(pCtrl,NVTEVT_CB_MOVIE_FINISH,0);
    }
    Ux_SendEvent(&UISystemObjCtrl,NVTEVT_CHANGE_DSCMODE,1,DSCMODE_CHGTO_NEXT);
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnKeyPlayback(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    Ux_SendEvent(&UISystemObjCtrl,NVTEVT_FORCETO_PLAYBACK_MODE,0);
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnBattery(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    UIFlowWndMovie_Update_Info();
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnChildClose(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    UINT32 uiWnd = g_uiChildWndMode;
    /* Reset child window record */
    g_uiChildWndMode = MOVIE_CHILD_WND_NULL;
    //debug_err(("UIFlowWndMovie_OnChildClose.uiWnd = 0x%x\n\r",uiWnd));
    switch(uiWnd)
    {
        case MOVIE_CHILD_WND_WRNMSG:
            if(paramNum > 0)
            {
                if(paramArray[0] == NVTRET_ENTER_MENU)
                {
                    /* Create Menu window */
                    g_uiChildWndMode = MOVIE_CHILD_WND_MENU;
                    Ux_OpenWindow(&UIMenuWndMovieVideoCtrl,0);
                    return NVTEVT_CONSUME;
                }
            }
            break;

        case MOVIE_CHILD_WND_MENU:
        case MOVIE_CHILD_WND_QUICKSETTING:
        default:
            g_uiMaskKeyPress = MOVIE_KEY_PRESS_MASK;
            g_uiMaskKeyRelease = MOVIE_KEY_RELEASE_MASK;
            KeyScan_SetKeyMask(KEYSCAN_KEYMODE_PRESS, g_uiMaskKeyPress);
            KeyScan_SetKeyMask(KEYSCAN_KEYMODE_RELEASE, g_uiMaskKeyRelease);
            /* Update window info */
            UIFlowWndMovie_Update_Info();
            break;
    }
    Ux_DefaultEvent(pCtrl,NVTEVT_CHILD_CLOSE,paramNum,paramArray);
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnMovieFinish(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    UINT16 uhFolderId, uhFileId;
    DbgMsg_UIRecAvi(("FlowMovie_OnMovieFinish:paramNum=%d,recording=%d\r\n",paramNum,gUIAviIsRecording));
    if (gUIAviIsRecording == TRUE)
    {
#if (_MOVIE_DIS_MODE_ == ENABLE)
        //#NT#2010/11/09#Hideo Lin -begin
        //#NT#Marked; using callback function to set display view
        /*
        if (Get_MovieDISIndex() == MOVIE_DIS_ON)
        {
            ide_disableVideo(IDE_VIDEOID_1);
            PhotoDis_setMode(PHOTODIS_MODE_IDLE, TRUE);
            PhotoDisplay_SetMode(DISPLAY_MODE_VIDEO, TRUE);
            // Delay 4 frames to avoid seeing error picture
            sie_waitVD(4);
            ide_enableVideo(IDE_VIDEOID_1);
        }
        */
        //#NT#2010/11/09#Hideo Lin -end
#endif

        if(UI_Validate_Storage(STORAGE_CHECK_FULL, &(gUIAviRecMaxTime)) != FALSE)
        {
            FilesysGetDCFNextID(&uhFolderId,&uhFileId);
            Set_FilesysDirId(uhFolderId);
            Set_FilesysFileId(uhFileId);
            DbgMsg_UIRecAvi(("Finish:D=%d,F=%d,FS=%d\r\n",Get_FilesysDirId(),Get_FilesysFileId(),GetFSStatus()));
            Save_MenuInfo();
        }
        gUIAviIsRecording = FALSE;
        KeyScan_EnableAutoPoweroff(TRUE);
        KeyScan_EnableUSBDet(TRUE);
        FlowMovie_DrawMaxRecTime(TRUE);
        UxCtrl_SetShow(&UIFlowWndMovie_PanelCtrl,FALSE);
        if (FlowMovie_ChkDrawStoreFullFolderFull() == FALSE)
        {
            DbgMsg_UIRecAvi(("Stop Rec-Avi Done\r\n\r\n"));
            UIFlowWndMovie_Update_Info();
            KeyScan_SetKeyMask(KEYSCAN_KEYMODE_PRESS, MOVIE_KEY_PRESS_MASK);
        }
        else
        {
            DbgMsg_UIRecAvi(("Stop Rec-Avi but Folder or Store Full\r\n\r\n"));
            return NVTEVT_CONSUME;
        }
    }
    else
    {
        debug_err(("Stop Rec-Avi but gUIAviIsRecording is FALSE\r\n"));
    }
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnMovieOneSec(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    DbgMsg_UIRecAvi(("FlowMovie_OnMovieOneSec:recSec=%d,recording=%d\r\n",*paramArray,gUIAviIsRecording));
    if (gUIAviIsRecording == TRUE)
    {
        UxCtrl_SetShow(&UIFlowWndMovie_PanelCtrl,!UxCtrl_IsShow(&UIFlowWndMovie_PanelCtrl));
        FlowMovie_DrawRecTime(TRUE, *paramArray);
    }
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnMovieFull(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    UINT16 uhFolderId, uhFileId;
    DbgMsg_UIRecAvi(("FlowMovie_OnMovieFull\r\n"));
    if (gUIAviIsRecording == TRUE)
    {
        DbgMsg_UIRecAvi(("Store Full,Stop Rec Avi:D=%d,F=%d,FS=%d\r\n",Get_FilesysDirId(),Get_FilesysFileId(),GetFSStatus()));

        FlowMovie_StopRec(FALSE);
        gUIAviStoreFull = TRUE;

        if(UI_Validate_Storage(STORAGE_CHECK_FULL, &(gUIAviRecMaxTime)) != FALSE)
        {
            FilesysGetDCFNextID(&uhFolderId,&uhFileId);
            Set_FilesysDirId(uhFolderId);
            Set_FilesysFileId(uhFileId);
            DbgMsg_UIRecAvi(("Finish:D=%d,F=%d,FS=%d\r\n",Get_FilesysDirId(),Get_FilesysFileId(),GetFSStatus()));
            Save_MenuInfo();
        }
        if (GetCardStatus() == CARD_REMOVED)
        {
            DbgMsg_UIRecAvi(("#RevIntrMem Full \r\n"));
            g_uiChildWndMode = MOVIE_CHILD_WND_WRNMSG;
            Ux_OpenWindow(&UIFlowWndWrnMsgCtrl,2,UIFlowWndWrnMsg_StatusTXT_Msg_STRID_MEMORY_FULL,FLOWWRNMSG_TIMER_KEEP);
            return NVTEVT_CONSUME;
        }
        else
        {
            DbgMsg_UIRecAvi(("#RevCard Full \r\n"));
            g_uiChildWndMode = MOVIE_CHILD_WND_WRNMSG;
            Ux_OpenWindow(&UIFlowWndWrnMsgCtrl,2,UIFlowWndWrnMsg_StatusTXT_Msg_STRID_CARD_FULL,FLOWWRNMSG_TIMER_KEEP);
            return NVTEVT_CONSUME;
        }
    }
    else
    {
        KeyScan_SetKeyMask(KEYSCAN_KEYMODE_PRESS,MOVIE_KEY_PRESS_MASK);
        debug_err(("Err: Store Full but gUIAviIsRecording is FALSE\r\n"));
    }
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnMovieWrError(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    UINT16 uhFolderId, uhFileId;
    DbgMsg_UIRecAvi(("UIFlowWndMovie_OnMovieWrError\r\n"));
    if (gUIAviIsRecording == TRUE)
    {
        DbgMsg_UIRecAvi(("Wr err,Stop Rec Avi:D=%d,F=%d,FS=%d\r\n",Get_FilesysDirId(),Get_FilesysFileId(),GetFSStatus()));

        FlowMovie_StopRec(FALSE);

        if (GetCardStatus() == CARD_LOCKED)
        {
            g_uiChildWndMode = MOVIE_CHILD_WND_WRNMSG;
            Ux_OpenWindow(&UIFlowWndWrnMsgCtrl,2,UIFlowWndWrnMsg_StatusTXT_Msg_STRID_CARD_LOCKED,FLOWWRNMSG_TIMER_3SEC);
            return NVTEVT_CONSUME;
        }
        else
        {
            g_uiChildWndMode = MOVIE_CHILD_WND_WRNMSG;
            Ux_OpenWindow(&UIFlowWndWrnMsgCtrl,2,UIFlowWndWrnMsg_StatusTXT_Msg_STRID_MEMORYERROR,FLOWWRNMSG_TIMER_3SEC);
            return NVTEVT_CONSUME;
        }
    }
    else
    {
        KeyScan_SetKeyMask(KEYSCAN_KEYMODE_PRESS,MOVIE_KEY_PRESS_MASK);
        debug_err(("Err: Store Full but gUIAviIsRecording is FALSE\r\n"));
    }
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnOZoomStepChange(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnDZoomStepChange(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    AlgMsgInfo *pAlgMsgInfo = Get_AlgMsgInfo();

    /* Update digital zoom ratio OSD string */
    UxStatic_SetData(&UIFlowWndMovie_Zoom_StaticCtrl,STATIC_VALUE,Txt_Pointer(Get_DZoomRatioString(pAlgMsgInfo)));

    if(pAlgMsgInfo->DzoomIndex > UI_DZOOM_IDX_MIN)
        UxCtrl_SetShow(&UIFlowWndMovie_Zoom_StaticCtrl,TRUE);
    else
        UxCtrl_SetShow(&UIFlowWndMovie_Zoom_StaticCtrl,FALSE);

    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnStorageChange(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    //FilesysWaitInitFinish(FST_TIME_INFINITE);
    debug_err(("[UIFlowWndMovie_OnStorageChange]\n\r"));
    UIFlowWndMovie_Update_Info();
    KeyScan_SetKeyMask(KEYSCAN_KEYMODE_PRESS, g_uiMaskKeyPress);
    KeyScan_SetKeyMask(KEYSCAN_KEYMODE_RELEASE, g_uiMaskKeyRelease);

    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnMacroChange(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    debug_err(("UIFlowWndMovie_OnMacroChange: OnMacroChange - %s\r\n", (Get_MacroIndex() == MACRO_ON)? "ON" : "OFF"));
    UIFlowWndMovie_Update_Info();
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnTimer(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    NVT_USER_EVT key;
    key = paramArray[0];
 //   debug_err(("UIFlowWndMovie_OnTimer\n\r"));
    if(Get_DisplayIndex() != DISPLAY_OFF)
    {
        switch(key)
        {
        case NVTEVT_2SEC_TIMER:
            Ux_PostEvent(NVTEVT_REDRAW, 0);
            break;
        case NVTEVT_1SEC_TIMER:
            #if 0
            //update time
            {
                RTC_DATE    Date;
                RTC_TIME    Time;
                Date = rtc_getDate();
                Time = rtc_getTime();
                sprintf(date_str,"%04d/%02d/%02d",Date.s.year,Date.s.month,Date.s.day);
                sprintf(time_str,"%02d:%02d:%02d",Time.s.hour,Time.s.minute,Time.s.second);
             //   debug_err(("date_str=%s\n\r",date_str));
             //   debug_err(("time_str=%s\n\r",time_str));
                UxStatic_SetData(&UIFlowWndMovie_YMD_StaticCtrl,STATIC_VALUE,Txt_Pointer(date_str));
                UxStatic_SetData(&UIFlowWndMovie_HMS_StaticCtrl,STATIC_VALUE,Txt_Pointer(time_str));
            }
            #endif
            break;
        }
    }
    Ux_DefaultEvent(pCtrl,NVTEVT_TIMER,paramNum,paramArray);
    return NVTEVT_CONSUME;
}
//----------------------UIFlowWndMovie_Static_cameraCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Static_camera)
EVENT_END

//----------------------UIFlowWndMovie_Status_aeCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Status_ae)
EVENT_END

//----------------------UIFlowWndMovie_Status_awbCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Status_awb)
EVENT_END

//----------------------UIFlowWndMovie_Status_batteryCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Status_battery)
EVENT_END

//---------------------UIFlowWndMovie_PanelCtrl Control List---------------------------
CTRL_LIST_BEGIN(UIFlowWndMovie_Panel)
CTRL_LIST_END

//----------------------UIFlowWndMovie_PanelCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Panel)
EVENT_END

//----------------------UIFlowWndMovie_Static_timeCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Static_time)
EVENT_END

//----------------------UIFlowWndMovie_Static_maxtimeCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Static_maxtime)
EVENT_END

//----------------------UIFlowWndMovie_Static_resolutionCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Static_resolution)
EVENT_END

//----------------------UIFlowWndMovie_Zoom_StaticCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Zoom_Static)
EVENT_END
//extern void UIFlowWndPhoto_GetHistogram(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray);   //Temporarily marked for extern

//----------------------UIFlowWnd_HistoCtrl Event---------------------------
INT32 UIFlowWnd_Histo_OnTimer(VControl *, UINT32, UINT32 *);
INT32 UIFlowWnd_Histo_OnRedraw(VControl *, UINT32, UINT32 *);
EVENT_BEGIN(UIFlowWnd_Histo)
EVENT_ITEM(NVTEVT_TIMER,UIFlowWnd_Histo_OnTimer)
EVENT_ITEM(NVTEVT_REDRAW,UIFlowWnd_Histo_OnRedraw)
EVENT_END

INT32 UIFlowWnd_Histo_OnTimer(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    NVT_USER_EVT key;
    key = paramArray[0];
debug_err(("UIFlowWnd_Histo_OnTimer\n\r"));
    if(Get_DisplayIndex() != DISPLAY_OFF)
    {
        switch(key)
        {
        case NVTEVT_2SEC_TIMER:
            Ux_PostEvent(NVTEVT_REDRAW, 0);
            break;
        case NVTEVT_1SEC_TIMER:
            UIFlowWndMovie_Update_Info();
            break;
        }
    }
    Ux_DefaultEvent(pCtrl,NVTEVT_TIMER,paramNum,paramArray);

    return NVTEVT_CONSUME;
}
INT32 UIFlowWnd_Histo_OnRedraw(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    //debug_err(("UIFlowWnd_Histo_OnTimer [%d]\n\r",Get_DisplayIndex()));
    //UxStatic_SetData(&UIFlowWndMovie_Zoom_StaticCtrl,STATIC_VALUE,Txt_Pointer(dzoom_Buf[Get_UIDzoomIndex()]));
    if(Get_DisplayIndex() == 1)
    {
        //UIFlowWndCommon_GetHistogram(pCtrl,paramNum,paramArray);   //Temporarily marked for extern
        UxCtrl_SetDirty(pCtrl, TRUE);
        Ux_DefaultEvent(pCtrl,NVTEVT_REDRAW,paramNum,paramArray);
    }
    else
    {
        if(gHistogram_show_timer != NULL_TIMER)
        {
            KeyScan_stopTimer(&gHistogram_show_timer);
        }
    }

    return NVTEVT_CONSUME;
}
//----------------------UIFlowWndMovie_YMD_StaticCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_YMD_Static)
EVENT_END

//----------------------UIFlowWndMovie_HMS_StaticCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_HMS_Static)
EVENT_END

//----------------------UIFlowWndMovie_Macro_StatusCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Macro_Status)
EVENT_END

//----------------------UIFlowWndMovie_StatusICN_StorageCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_StatusICN_Storage)
EVENT_END

//----------------------UIFlowWndMovie_StaticIcon_PIMCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_StaticIcon_PIM)
EVENT_END

//----------------------UIFlowWndMovie_StatusIcon_DISCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_StatusIcon_DIS)
EVENT_END

