//This source code is generated by UI Designer Studio.
#include <stdio.h>
#include <string.h>
#include "UIFramework.h"
#include "UIFrameworkExt.h"
#include "UIGraphics.h"
#include "NVTToolCommand.h"
#include "UIFlowWndMP3Res.c"
#include "UIFlowWndMP3.h"
#include "UIFlow.h"
#include "UISystemStatusSettings.h"
#include "UIMenuWndSetup.h"
#include "UISystemObj.h"
#include "UIGraphics.h"
#include "PrimaryTsk.h"
#include "Utility.h"
#include "AppInit.h"
#include "KeyScanTsk.h"
#include "AppInit.h"
#include "FilesysTsk.h"
#include "MP3Api.h"
#include "UserPStore.h"


//-----------------------------------------------------------------------------
// UIFlowWndMP3 User Variable & Function Declarations
//-----------------------------------------------------------------------------
#define MP3_LONGFILENAME_LEN_MAX        256
#define SONG_MARQUEE_TIME               200

#define MARQUEE_MOVE_STEP               4
#define MARQUEE_MOVE_LEFT               0
#define MARQUEE_MOVE_RIGHT              1

#define MP3ITEM_NUM_PER_PAGE            4
#define MP3ITEM_ICON_NULL               ICONID_NULL
#define MP3ITEM_ICON_FILE               ICON_VOICE
#define MP3ITEM_ICON_PLAY               ICON_AUDPLAY
#define MP3ITEM_ICON_PAUSE              ICON_AUDPAUSE
#define MP3ITEM_ICON_STOP               ICON_AUDSTOP

typedef struct{
    UINT32      uiTotalNum;
    UINT32      uiDisplayStartNum;
    UINT32      uiDisplayEndNum;
    UINT32      uiDisplayCurrNum;
    UINT32      uiPlayingNum;
    UINT32      uiPlayingCurrTime;
    UINT32      uiPlayingTotalTime;
    UINT32      uiPlayMode;
    UINT32      uiMP3PlayBufAddr;
} UI_MP3PLAYOBJ, *PUI_MP3PLAYOBJ;

static UI_MP3PLAYOBJ g_UIMP3Obj;

static UINT32 g_uiMaskKeyPress          = MP3_KEY_PRESS_MASK;
static UINT32 g_uiMaskKeyRelease        = MP3_KEY_RELEASE_MASK;
static UINT32 g_uiMaskKeyContinue       = MP3_KEY_CONTINUE_MASK;
static UINT32 g_uiChildWndMode          = MP3_CHILD_WND_NULL;

static UINT32 g_uiSongMarqueeTimerID    = NULL_TIMER;
static SIZE_2D g_SongStrSize            = 0;
static UINT32 g_uiMarqueeMoveCnt        = 0;
static UINT32 g_uiMarqueeMoveDir        = MARQUEE_MOVE_LEFT;

static Ux_RECT gClipping_Wnd_default    = {52,5,288,36};
static Ux_RECT gClipping_Wnd            = {52,5,288,36};
static Ux_RECT gClipping_Wnd_item[MP3ITEM_NUM_PER_PAGE]     = {{52,50,288,81},
                                                               {52,92,288,123},
                                                               {52,134,288,165},
                                                               {52,176,288,207}};
static Ux_RECT gClipping_Menu_Wnd       = {20,10,80,30};

static CHAR g_MenuMP3Item[MP3ITEM_NUM_PER_PAGE][MP3_LONGFILENAME_LEN_MAX];
static CHAR g_MP3SelectNumStr[32];
static CHAR g_MP3PlayTimeStr[64];


static void UIFlowWndMP3_InitUniCodeFont(void);
static void UIFlowWndMP3_InitUIMP3Obj(void);
static void UIFlowWndMP3_UpdateWndInfo(void);
static void UIFlowWndMP3_StartMP3Playing(UINT32);
static CHAR *UIFlowWndMP3_GetSelectNumString(UINT32, UINT32);
static CHAR *UIFlowWndMP3_GetMP3PlayTimeString(UINT32, UINT32);
static UINT32 UIFlowWndMP3_GetTotalTimeByOrder(UINT32);
static void UIFlowWndMP3_FillMenuTable(void);
static void UIFlowWndMP3_StartSongMarquee(void);

//-----------------------------------------------------------------------------
// UIFlowWndMP3 ToolGen
//-----------------------------------------------------------------------------
//---------------------UIFlowWndMP3Ctrl Control List---------------------------
CTRL_LIST_BEGIN(UIFlowWndMP3)
CTRL_LIST_ITEM(MP3_TitleBar)
CTRL_LIST_ITEM(MP3_Main_Background)
CTRL_LIST_ITEM(MP3_Main_Menu)
CTRL_LIST_ITEM(MP3_Menu_ScrollBar)
CTRL_LIST_ITEM(MP3_Menu_Panel)
CTRL_LIST_ITEM(MP3_Menu_RunPanel)
CTRL_LIST_ITEM(MP3_TipsBar)
CTRL_LIST_ITEM(MP3_Icon_OK)
CTRL_LIST_ITEM(MP3_Text_Play)
CTRL_LIST_ITEM(MP3_Text_SelectNum)
CTRL_LIST_ITEM(MP3_Icon_Battery)
CTRL_LIST_END

//----------------------UIFlowWndMP3Ctrl Event---------------------------
INT32 UIFlowWndMP3_OnOpen(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMP3_OnClose(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMP3_OnChildClose(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMP3_OnKeyMenu(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMP3_OnKeyMode(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMP3_OnKeyPlayback(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMP3_OnStorageInit(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMP3_OnStorageChange(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMP3_OnBattery(VControl *, UINT32, UINT32 *);
EVENT_BEGIN(UIFlowWndMP3)
EVENT_ITEM(NVTEVT_OPEN_WINDOW,UIFlowWndMP3_OnOpen)
EVENT_ITEM(NVTEVT_CLOSE_WINDOW,UIFlowWndMP3_OnClose)
EVENT_ITEM(NVTEVT_CHILD_CLOSE,UIFlowWndMP3_OnChildClose)
EVENT_ITEM(NVTEVT_KEY_MENU,UIFlowWndMP3_OnKeyMenu)
EVENT_ITEM(NVTEVT_KEY_MODE,UIFlowWndMP3_OnKeyMode)
EVENT_ITEM(NVTEVT_KEY_PLAYBACK,UIFlowWndMP3_OnKeyPlayback)
EVENT_ITEM(NVTEVT_STORAGE_INIT,UIFlowWndMP3_OnStorageInit)
EVENT_ITEM(NVTEVT_STORAGE_CHANGE,UIFlowWndMP3_OnStorageChange)
EVENT_ITEM(NVTEVT_BATTERY,UIFlowWndMP3_OnBattery)
EVENT_END

INT32 UIFlowWndMP3_OnOpen(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    debug_ind(("UIFlowWndMP3: OnOpen\r\n"));

    /* Init MP3 unicode font (from PStore) */
    UIFlowWndMP3_InitUniCodeFont();

    /* Init MP3 UI object */
    UIFlowWndMP3_InitUIMP3Obj();

    /* Init Menu UI */
    UIFlowWndMP3_UpdateWndInfo();
    UxMenu_SetData(&MP3_Main_MenuCtrl, MNU_TOTITM, MP3ITEM_NUM_PER_PAGE);
    if(g_UIMP3Obj.uiTotalNum == 0)
    {
        UxCtrl_SetShow(&MP3_Text_PlayTimeCtrl,FALSE);
        UxCtrl_SetShow(&MP3_Menu_PanelCtrl,TRUE);
        UxScrollBar_SetData(&MP3_Menu_ScrollBarCtrl,SCRBAR_TOTSTP,1);
        UxCtrl_SetShow(&MP3_Text_SongCtrl,FALSE);
        UxCtrl_SetShow(&MP3_Icon_OKCtrl,FALSE);
        UxCtrl_SetShow(&MP3_Text_SelectNumCtrl,FALSE);
        UxMenu_SetData(&MP3_Main_MenuCtrl,MNU_CURITM,0);
    }
    else
    {
        UxCtrl_SetShow(&MP3_Text_PlayTimeCtrl,TRUE);
        UxCtrl_SetShow(&MP3_Menu_PanelCtrl,FALSE);
        UxScrollBar_SetData(&MP3_Menu_ScrollBarCtrl,SCRBAR_TOTSTP,g_UIMP3Obj.uiTotalNum);
        UxCtrl_SetShow(&MP3_Text_SongCtrl,TRUE);
        UxCtrl_SetShow(&MP3_Icon_OKCtrl,TRUE);
        UxCtrl_SetShow(&MP3_Text_SelectNumCtrl,TRUE);
        UxMenu_SetData(&MP3_Main_MenuCtrl,MNU_CURITM,g_UIMP3Obj.uiDisplayEndNum - g_UIMP3Obj.uiDisplayStartNum);
    }

    UxCtrl_SetShow(&MP3_Text_MP3ModeCtrl,TRUE);
    UxStatic_SetData(&MP3_Text_PlayTimeCtrl,STATIC_VALUE,Txt_Pointer(UIFlowWndMP3_GetMP3PlayTimeString(0, g_UIMP3Obj.uiPlayingTotalTime)));
    UxStatic_SetData(&MP3_Text_SelectNumCtrl,STATIC_VALUE,Txt_Pointer(UIFlowWndMP3_GetSelectNumString((g_UIMP3Obj.uiDisplayCurrNum + 1), g_UIMP3Obj.uiTotalNum)));

    UIFlowWndMP3_FillMenuTable();
    UxScrollBar_SetData(&MP3_Menu_ScrollBarCtrl,SCRBAR_PAGESTP,0);
    UxScrollBar_SetData(&MP3_Menu_ScrollBarCtrl,SCRBAR_CURSTP,g_UIMP3Obj.uiDisplayCurrNum);
    if(g_UIMP3Obj.uiDisplayCurrNum != g_UIMP3Obj.uiPlayingNum)
    {
        UxState_SetData(&MP3_Text_PlayCtrl,STATE_CURITEM,MP3_Text_Play_STRID_PLAY);
    }
    else
    {
        if(MP3Play_GetMP3CurrStatus() == MP3PLAY_PLAYING)
            UxState_SetData(&MP3_Text_PlayCtrl,STATE_CURITEM,MP3_Text_Play_STRID_PAUSE);
        else
            UxState_SetData(&MP3_Text_PlayCtrl,STATE_CURITEM,MP3_Text_Play_STRID_PLAY);
    }

    UIFlowWndMP3_StartSongMarquee();

    /* Set key press/release/continue mask */
    g_uiMaskKeyPress = MP3_KEY_PRESS_MASK;
    g_uiMaskKeyRelease = MP3_KEY_RELEASE_MASK;
    g_uiMaskKeyContinue = MP3_KEY_CONTINUE_MASK;
    Ux_FlushEvent();
    KeyScan_SetKeyMask(KEYSCAN_KEYMODE_PRESS, g_uiMaskKeyPress);
    KeyScan_SetKeyMask(KEYSCAN_KEYMODE_RELEASE, g_uiMaskKeyRelease);
    KeyScan_SetKeyMask(KEYSCAN_KEYMODE_CONTINUE, g_uiMaskKeyContinue);

    Ux_DefaultEvent(pCtrl,NVTEVT_OPEN_WINDOW,paramNum,paramArray);
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMP3_OnClose(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    debug_ind(("UIFlowWndMP3: OnClose\r\n"));

    /* Stop song marquee timer if exists */
    if(g_uiSongMarqueeTimerID != NULL_TIMER)
    {
        KeyScan_stopTimer(&g_uiSongMarqueeTimerID);
    }
    UxCtrl_SetPos(&MP3_Menu_RunPanelCtrl, gClipping_Wnd_default);

    /* Reset key press/release/continue mask to default */
    Ux_FlushEvent();
    KeyScan_SetKeyMask(KEYSCAN_KEYMODE_PRESS, FLGKEY_KEY_MASK_DEFAULT);
    KeyScan_SetKeyMask(KEYSCAN_KEYMODE_RELEASE, FLGKEY_KEY_REL_MASK_DEFAULT);
    KeyScan_SetKeyMask(KEYSCAN_KEYMODE_CONTINUE, FLGKEY_KEY_CONT_MASK_DEFAULT);

    Ux_DefaultEvent(pCtrl,NVTEVT_CLOSE_WINDOW,paramNum,paramArray);
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMP3_OnChildClose(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    UINT32 uiWnd = g_uiChildWndMode;

    /* Set key mask to self-original state */
    Ux_FlushEvent();
    KeyScan_SetKeyMask(KEYSCAN_KEYMODE_PRESS, g_uiMaskKeyPress);
    KeyScan_SetKeyMask(KEYSCAN_KEYMODE_RELEASE, g_uiMaskKeyRelease);
    KeyScan_SetKeyMask(KEYSCAN_KEYMODE_CONTINUE, g_uiMaskKeyContinue);

    /* Reset child window record */
    g_uiChildWndMode = MP3_CHILD_WND_NULL;

    switch(uiWnd)
    {
        case PHOTO_CHILD_WND_MENU:
        default:
            /* Update window info */
            UIFlowWndMP3_UpdateWndInfo();
            break;
    }

    Ux_DefaultEvent(pCtrl,NVTEVT_CHILD_CLOSE,paramNum,paramArray);
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMP3_OnKeyMenu(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
#if 0   //Rsvd
    g_uiChildWndMode = MP3_CHILD_WND_MENU;
    Ux_OpenWindow(&UIMenuWndSetupCtrl,0);
#endif
    Ux_DefaultEvent(pCtrl,NVTEVT_KEY_MENU,paramNum,paramArray);
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMP3_OnKeyMode(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    Ux_SendEvent(&UISystemObjCtrl,NVTEVT_CHANGE_DSCMODE,1,DSCMODE_CHGTO_NEXT);
    Ux_DefaultEvent(pCtrl,NVTEVT_KEY_MODE,paramNum,paramArray);
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMP3_OnKeyPlayback(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    Ux_SendEvent(&UISystemObjCtrl,NVTEVT_FORCETO_PLAYBACK_MODE,0);
    Ux_DefaultEvent(pCtrl,NVTEVT_KEY_PLAYBACK,paramNum,paramArray);
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMP3_OnStorageInit(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    BOOL bCurrCardRemoved = (GetCardStatus() == CARD_REMOVED)? TRUE : FALSE;

    debug_err(("UIFlowWndMP3: OnStorageInit - %s\r\n", (bCurrCardRemoved)? "MEM" : "Card"));
    Ux_DefaultEvent(pCtrl,NVTEVT_STORAGE_INIT,paramNum,paramArray);
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMP3_OnStorageChange(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    Ux_DefaultEvent(pCtrl,NVTEVT_STORAGE_CHANGE,paramNum,paramArray);
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMP3_OnBattery(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    UIFlowWndMP3_UpdateWndInfo();
    Ux_DefaultEvent(pCtrl,NVTEVT_BATTERY,paramNum,paramArray);
    return NVTEVT_CONSUME;
}
//---------------------MP3_TitleBarCtrl Control List---------------------------
CTRL_LIST_BEGIN(MP3_TitleBar)
CTRL_LIST_ITEM(MP3_Text_PlayTime)
CTRL_LIST_ITEM(MP3_Text_MP3Mode)
CTRL_LIST_END

//----------------------MP3_TitleBarCtrl Event---------------------------
EVENT_BEGIN(MP3_TitleBar)
EVENT_END

//----------------------MP3_Text_PlayTimeCtrl Event---------------------------
EVENT_BEGIN(MP3_Text_PlayTime)
EVENT_END

//----------------------MP3_Text_MP3ModeCtrl Event---------------------------
EVENT_BEGIN(MP3_Text_MP3Mode)
EVENT_END

//---------------------MP3_Main_BackgroundCtrl Control List---------------------------
CTRL_LIST_BEGIN(MP3_Main_Background)
CTRL_LIST_END

//----------------------MP3_Main_BackgroundCtrl Event---------------------------
EVENT_BEGIN(MP3_Main_Background)
EVENT_END

//----------------------MP3_Main_MenuCtrl Event---------------------------
INT32 MP3_Main_Menu_OnKeyDown(VControl *, UINT32, UINT32 *);
INT32 MP3_Main_Menu_OnKeyUp(VControl *, UINT32, UINT32 *);
INT32 MP3_Main_Menu_OnKeyEnter(VControl *, UINT32, UINT32 *);
INT32 MP3_Main_Menu_OnTimer(VControl *, UINT32, UINT32 *);
INT32 MP3_Main_Menu_OnMP3PlayOneSecond(VControl *, UINT32, UINT32 *);
INT32 MP3_Main_Menu_OnMP3PlayFinish(VControl *, UINT32, UINT32 *);
INT32 MP3_Main_Menu_OnBeginCtrl(VControl *, UINT32, UINT32 *);
INT32 MP3_Main_Menu_OnEndCtrl(VControl *, UINT32, UINT32 *);
EVENT_BEGIN(MP3_Main_Menu)
EVENT_ITEM(NVTEVT_KEY_ZOOMOUT,MP3_Main_Menu_OnKeyDown)
EVENT_ITEM(NVTEVT_KEY_ZOOMIN,MP3_Main_Menu_OnKeyUp)
EVENT_ITEM(NVTEVT_KEY_SHUTTER2,MP3_Main_Menu_OnKeyEnter)
EVENT_ITEM(NVTEVT_TIMER,MP3_Main_Menu_OnTimer)
EVENT_ITEM(NVTEVT_CB_MP3PLAY_ONESECOND,MP3_Main_Menu_OnMP3PlayOneSecond)
EVENT_ITEM(NVTEVT_CB_MP3PLAY_FINISH,MP3_Main_Menu_OnMP3PlayFinish)
EVENT_ITEM(NVTEVT_BEGIN_CTRL,MP3_Main_Menu_OnBeginCtrl)
EVENT_ITEM(NVTEVT_END_CTRL,MP3_Main_Menu_OnEndCtrl)
EVENT_END

INT32 MP3_Main_Menu_OnKeyDown(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    UINT32 uiCurrMenuItem, uiTotalMenuItem;

    debug_err(("UIFlowWndMP3: OnKeyDown\r\n"));

    if(g_UIMP3Obj.uiTotalNum == 0)
        return NVTEVT_CONSUME;

    /* Suspend all keys */
    KeyScan_SetKeyMask(KEYSCAN_KEYMODE_PRESS, FLGKEY_KEY_MASK_NULL);
    /* Stop song marquee timer */
    if(g_uiSongMarqueeTimerID != NULL_TIMER)
    {
        KeyScan_stopTimer(&g_uiSongMarqueeTimerID);
    }
    /* Restore menu */
    UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + UxMenu_GetData(pCtrl,MNU_CURITM), MNUITM_STRID, Txt_Pointer(g_MenuMP3Item[UxMenu_GetData(pCtrl,MNU_CURITM)]));

    if(g_UIMP3Obj.uiTotalNum > MP3ITEM_NUM_PER_PAGE)
    {
        uiCurrMenuItem = UxMenu_GetData(pCtrl,MNU_CURITM);
        uiTotalMenuItem = UxMenu_GetData(pCtrl,MNU_TOTITM);
        debug_err(("%d %d %d %d\n\r", uiCurrMenuItem, uiTotalMenuItem, g_UIMP3Obj.uiDisplayCurrNum, g_UIMP3Obj.uiTotalNum));

        if((uiTotalMenuItem - 1) == uiCurrMenuItem)
        {//last one
            if(g_UIMP3Obj.uiDisplayCurrNum == (g_UIMP3Obj.uiTotalNum - 1))
            {
                g_UIMP3Obj.uiDisplayCurrNum = 0;
                g_UIMP3Obj.uiDisplayStartNum = 0;
                g_UIMP3Obj.uiDisplayEndNum  = (MP3ITEM_NUM_PER_PAGE - 1);
            }
            else
            {
                g_UIMP3Obj.uiDisplayCurrNum = g_UIMP3Obj.uiDisplayCurrNum + 1;
                g_UIMP3Obj.uiDisplayStartNum = g_UIMP3Obj.uiDisplayCurrNum - (MP3ITEM_NUM_PER_PAGE - 1);
                g_UIMP3Obj.uiDisplayEndNum  = g_UIMP3Obj.uiDisplayCurrNum;
            }

            UIFlowWndMP3_FillMenuTable();

            if(g_UIMP3Obj.uiDisplayCurrNum == 0)
                UxMenu_SetData(&MP3_Main_MenuCtrl,MNU_CURITM,0);
            else
                UxMenu_SetData(&MP3_Main_MenuCtrl,MNU_CURITM,g_UIMP3Obj.uiDisplayEndNum - g_UIMP3Obj.uiDisplayStartNum);

            UxScrollBar_SetData(&MP3_Menu_ScrollBarCtrl,SCRBAR_CURSTP,g_UIMP3Obj.uiDisplayCurrNum);
            debug_err(("1 uiDisplayCurrNum = [%d]\n\r", g_UIMP3Obj.uiDisplayCurrNum));
        }
        else
        {
            g_UIMP3Obj.uiDisplayCurrNum=g_UIMP3Obj.uiDisplayCurrNum + 1;
            Ux_SendEvent(pCtrl,NVTEVT_NEXT_ITEM,0);
            UxScrollBar_SetData(&MP3_Menu_ScrollBarCtrl,SCRBAR_CURSTP,g_UIMP3Obj.uiDisplayCurrNum);
            debug_err(("2 uiDisplayCurrNum = [%d]\n\r", g_UIMP3Obj.uiDisplayCurrNum));
        }
    }
    else
    {
        Ux_SendEvent(pCtrl,NVTEVT_NEXT_ITEM,0);
        g_UIMP3Obj.uiDisplayCurrNum =  UxMenu_GetData(pCtrl,MNU_CURITM);
        UxScrollBar_SetData(&MP3_Menu_ScrollBarCtrl,SCRBAR_CURSTP,g_UIMP3Obj.uiDisplayCurrNum);
        debug_err(("3 uiDisplayCurrNum = [%d]\n\r", g_UIMP3Obj.uiDisplayCurrNum));
    }

    if(g_UIMP3Obj.uiDisplayCurrNum != g_UIMP3Obj.uiPlayingNum)
    {
        UxState_SetData(&MP3_Text_PlayCtrl,STATE_CURITEM,MP3_Text_Play_STRID_PLAY);
    }
    else
    {
        if(MP3Play_GetMP3CurrStatus() == MP3PLAY_PLAYING)
            UxState_SetData(&MP3_Text_PlayCtrl,STATE_CURITEM,MP3_Text_Play_STRID_PAUSE);
        else
            UxState_SetData(&MP3_Text_PlayCtrl,STATE_CURITEM,MP3_Text_Play_STRID_PLAY);
    }

    if((MP3Play_GetMP3CurrStatus() == MP3PLAY_PLAYING) || (MP3Play_GetMP3CurrStatus() == MP3PLAY_PAUSE))
    {
        //Do nothing
    }
    else
    {
        g_UIMP3Obj.uiPlayingCurrTime = 0;
        g_UIMP3Obj.uiPlayingTotalTime = UIFlowWndMP3_GetTotalTimeByOrder(g_UIMP3Obj.uiDisplayCurrNum);
        UxStatic_SetData(&MP3_Text_PlayTimeCtrl,STATIC_VALUE,Txt_Pointer(UIFlowWndMP3_GetMP3PlayTimeString(0, g_UIMP3Obj.uiPlayingTotalTime)));
    }
    UxStatic_SetData(&MP3_Text_SelectNumCtrl,STATIC_VALUE,Txt_Pointer(UIFlowWndMP3_GetSelectNumString((g_UIMP3Obj.uiDisplayCurrNum + 1), g_UIMP3Obj.uiTotalNum)));

    UIFlowWndMP3_StartSongMarquee();

    g_uiMarqueeMoveCnt = 0;
    g_uiMarqueeMoveDir = MARQUEE_MOVE_LEFT;
    TimerDelayMs(200);

    /* Resume key */
    KeyScan_SetKeyMask(KEYSCAN_KEYMODE_PRESS, g_uiMaskKeyPress);
    return NVTEVT_CONSUME;
}
INT32 MP3_Main_Menu_OnKeyUp(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    UINT32 uiCurrMenuItem, uiTotalMenuItem;

    debug_err(("UIFlowWndMP3: OnKeyUp\r\n"));

    if(g_UIMP3Obj.uiTotalNum == 0)
        return NVTEVT_CONSUME;

    /* Suspend all keys */
    KeyScan_SetKeyMask(KEYSCAN_KEYMODE_PRESS, FLGKEY_KEY_MASK_NULL);
    /* Stop song marquee timer */
    if(g_uiSongMarqueeTimerID != NULL_TIMER)
    {
        KeyScan_stopTimer(&g_uiSongMarqueeTimerID);
    }
    /* Restore menu */
    UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + UxMenu_GetData(pCtrl,MNU_CURITM), MNUITM_STRID, Txt_Pointer(g_MenuMP3Item[UxMenu_GetData(pCtrl,MNU_CURITM)]));

    if(g_UIMP3Obj.uiTotalNum > MP3ITEM_NUM_PER_PAGE)
    {
        uiCurrMenuItem = UxMenu_GetData(pCtrl,MNU_CURITM);
        uiTotalMenuItem = UxMenu_GetData(pCtrl,MNU_TOTITM);
        debug_err(("%d %d %d %d\n\r", uiCurrMenuItem, uiTotalMenuItem, g_UIMP3Obj.uiDisplayCurrNum, g_UIMP3Obj.uiTotalNum));

        if(uiCurrMenuItem == 0)
        {//menu first one
            if(g_UIMP3Obj.uiDisplayCurrNum == 0)
            {
                g_UIMP3Obj.uiDisplayCurrNum = g_UIMP3Obj.uiTotalNum - 1;
                g_UIMP3Obj.uiDisplayStartNum = g_UIMP3Obj.uiDisplayCurrNum - (MP3ITEM_NUM_PER_PAGE - 1);
                g_UIMP3Obj.uiDisplayEndNum  = g_UIMP3Obj.uiDisplayCurrNum;
            }
            else
            {
                g_UIMP3Obj.uiDisplayCurrNum = g_UIMP3Obj.uiDisplayCurrNum - 1;
                g_UIMP3Obj.uiDisplayStartNum = g_UIMP3Obj.uiDisplayCurrNum;
                g_UIMP3Obj.uiDisplayEndNum  = g_UIMP3Obj.uiDisplayCurrNum + (MP3ITEM_NUM_PER_PAGE - 1);
            }

            UIFlowWndMP3_FillMenuTable();

            if(g_UIMP3Obj.uiDisplayCurrNum == (g_UIMP3Obj.uiTotalNum - 1))
                UxMenu_SetData(&MP3_Main_MenuCtrl,MNU_CURITM,g_UIMP3Obj.uiDisplayEndNum - g_UIMP3Obj.uiDisplayStartNum);
            else
                UxMenu_SetData(&MP3_Main_MenuCtrl,MNU_CURITM,0);

            UxScrollBar_SetData(&MP3_Menu_ScrollBarCtrl,SCRBAR_CURSTP,g_UIMP3Obj.uiDisplayCurrNum);
            debug_err(("1 uiDisplayCurrNum = [%d]\n\r", g_UIMP3Obj.uiDisplayCurrNum));
        }
        else
        {
            g_UIMP3Obj.uiDisplayCurrNum = g_UIMP3Obj.uiDisplayCurrNum - 1;
            Ux_SendEvent(pCtrl,NVTEVT_PREVIOUS_ITEM,0);
            UxScrollBar_SetData(&MP3_Menu_ScrollBarCtrl,SCRBAR_CURSTP,g_UIMP3Obj.uiDisplayCurrNum);
            debug_err(("2 uiDisplayCurrNum = [%d]\n\r", g_UIMP3Obj.uiDisplayCurrNum));
        }
    }
    else
    {
        Ux_SendEvent(pCtrl,NVTEVT_PREVIOUS_ITEM,0);
        g_UIMP3Obj.uiDisplayCurrNum = UxMenu_GetData(pCtrl,MNU_CURITM);
        UxScrollBar_SetData(&MP3_Menu_ScrollBarCtrl,SCRBAR_CURSTP,g_UIMP3Obj.uiDisplayCurrNum);
        debug_err(("3 uiDisplayCurrNum = [%d]\n\r", g_UIMP3Obj.uiDisplayCurrNum));
    }

    if(g_UIMP3Obj.uiDisplayCurrNum != g_UIMP3Obj.uiPlayingNum)
    {
        UxState_SetData(&MP3_Text_PlayCtrl,STATE_CURITEM,MP3_Text_Play_STRID_PLAY);
    }
    else
    {
        if(MP3Play_GetMP3CurrStatus() == MP3PLAY_PLAYING)
            UxState_SetData(&MP3_Text_PlayCtrl,STATE_CURITEM,MP3_Text_Play_STRID_PAUSE);
        else
            UxState_SetData(&MP3_Text_PlayCtrl,STATE_CURITEM,MP3_Text_Play_STRID_PLAY);
    }

    if((MP3Play_GetMP3CurrStatus() == MP3PLAY_PLAYING) || (MP3Play_GetMP3CurrStatus() == MP3PLAY_PAUSE))
    {
        //Do nothing
    }
    else
    {
        g_UIMP3Obj.uiPlayingCurrTime = 0;
        g_UIMP3Obj.uiPlayingTotalTime = UIFlowWndMP3_GetTotalTimeByOrder(g_UIMP3Obj.uiDisplayCurrNum);
        UxStatic_SetData(&MP3_Text_PlayTimeCtrl,STATIC_VALUE,Txt_Pointer(UIFlowWndMP3_GetMP3PlayTimeString(0, g_UIMP3Obj.uiPlayingTotalTime)));
    }
    UxStatic_SetData(&MP3_Text_SelectNumCtrl,STATIC_VALUE,Txt_Pointer(UIFlowWndMP3_GetSelectNumString((g_UIMP3Obj.uiDisplayCurrNum + 1), g_UIMP3Obj.uiTotalNum)));

    UIFlowWndMP3_StartSongMarquee();

    g_uiMarqueeMoveCnt = 0;
    g_uiMarqueeMoveDir = MARQUEE_MOVE_LEFT;
    TimerDelayMs(200);

    /* Resume key */
    KeyScan_SetKeyMask(KEYSCAN_KEYMODE_PRESS, g_uiMaskKeyPress);
    return NVTEVT_CONSUME;
}
INT32 MP3_Main_Menu_OnKeyEnter(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    UINT32 i;

    debug_err(("UIFlowWndMP3: OnKeyEnter\r\n"));
    debug_err(("UIFlowWndMP3: CurrMP3Status = %d, uiDisplayCurrNum = %ld, uiPlayingNum = %ld\r\n", MP3Play_GetMP3CurrStatus(), g_UIMP3Obj.uiDisplayCurrNum, g_UIMP3Obj.uiPlayingNum));

    if(g_UIMP3Obj.uiDisplayCurrNum == g_UIMP3Obj.uiPlayingNum)
    {
        if((MP3Play_GetMP3CurrStatus() == MP3PLAY_PLAYING) || (MP3Play_GetMP3CurrStatus() == MP3PLAY_PAUSE))
        {
            MP3Play_StartOrResumePlaying();

            /* MP3 status will be renewed */
            if(MP3Play_GetMP3CurrStatus() == MP3PLAY_PLAYING)
            {
                UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + UxMenu_GetData(pCtrl,MNU_CURITM), MNUITM_ICONID, MP3ITEM_ICON_PLAY);
                UxState_SetData(&MP3_Text_PlayCtrl,STATE_CURITEM,MP3_Text_Play_STRID_PAUSE);
            }
            else
            {
                UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + UxMenu_GetData(pCtrl,MNU_CURITM), MNUITM_ICONID, MP3ITEM_ICON_PAUSE);
                UxState_SetData(&MP3_Text_PlayCtrl,STATE_CURITEM,MP3_Text_Play_STRID_PLAY);
            }
        }
        else   //if MP3Play_GetMP3CurrStatus() == MP3PLAY_STOP (Manually replay once!)
        {
            UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + UxMenu_GetData(pCtrl,MNU_CURITM), MNUITM_ICONID, MP3ITEM_ICON_PLAY);
            UxState_SetData(&MP3_Text_PlayCtrl,STATE_CURITEM,MP3_Text_Play_STRID_PAUSE);
            UIFlowWndMP3_StartMP3Playing(MP3PlayFileSys_GetFileIndex(MP3PlayFileSys_GetNowOrder()));   //No need changing mp3 noworder!
            UxStatic_SetData(&MP3_Text_PlayTimeCtrl,STATIC_VALUE,Txt_Pointer(UIFlowWndMP3_GetMP3PlayTimeString(0, g_UIMP3Obj.uiPlayingTotalTime)));
        }
    }
    else
    {
        if(g_UIMP3Obj.uiTotalNum != 0)
        {
            g_UIMP3Obj.uiPlayingNum = g_UIMP3Obj.uiDisplayCurrNum;

            for(i=0; i<MP3ITEM_NUM_PER_PAGE; i++)
            {
                switch(UxMenu_GetItemData(pCtrl,MP3_Main_Menu_STRID_A1 + i,MNUITM_ICONID))
                {
                case MP3ITEM_ICON_PLAY:
                case MP3ITEM_ICON_PAUSE:
                case MP3ITEM_ICON_STOP:
                    UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + i, MNUITM_ICONID, MP3ITEM_ICON_FILE);
                    break;
                case MP3ITEM_ICON_FILE:
                    break;
                case MP3ITEM_ICON_NULL:
                    UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + i, MNUITM_ICONID, MP3ITEM_ICON_NULL);
                    break;
                }

                if(UxMenu_GetData(pCtrl,MNU_CURITM) == i)
                {
                    UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + i, MNUITM_ICONID, MP3ITEM_ICON_PLAY);
                }
            }
            UxState_SetData(&MP3_Text_PlayCtrl,STATE_CURITEM,MP3_Text_Play_STRID_PAUSE);
            MP3PlayFileSys_SetNowOrder(g_UIMP3Obj.uiDisplayCurrNum);
            UIFlowWndMP3_StartMP3Playing(MP3PlayFileSys_GetFileIndex(MP3PlayFileSys_GetNowOrder()));
            UxStatic_SetData(&MP3_Text_PlayTimeCtrl,STATIC_VALUE,Txt_Pointer(UIFlowWndMP3_GetMP3PlayTimeString(0, g_UIMP3Obj.uiPlayingTotalTime)));
        }
    }

    UxCtrl_SetDirty(pCtrl->pParent,TRUE);
    Ux_DefaultEvent(pCtrl,NVTEVT_KEY_ENTER,paramNum,paramArray);
    return NVTEVT_CONSUME;
}
INT32 MP3_Main_Menu_OnTimer(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    NVTEVT event;

    event = paramArray[0];
    debug_ind(("UIFlowWndMP3: OnTimer event = 0x%x\r\n", event));

    switch(event)
    {
        case NVTEVT_MARQUEE_TIMER:
        {
            /**************************************************************************************
            **
            ** Marquee Timeout Action
            **
            **************************************************************************************/
            Ux_RECT NewPos;
            UINT32 uiMoveOffset = (g_SongStrSize.w - (gClipping_Wnd_item[0].x2 - gClipping_Wnd_item[0].x1 - 10));

            /* Stop song marquee timer */
            if(g_uiSongMarqueeTimerID !=  NULL_TIMER)
            {
                KeyScan_stopTimer(&g_uiSongMarqueeTimerID);
            }

            if(g_uiMarqueeMoveDir == MARQUEE_MOVE_LEFT)
            {
                NewPos = UxCtrl_GetPos(&MP3_Menu_RunPanelCtrl);
                NewPos.x1 = NewPos.x1 - MARQUEE_MOVE_STEP;
                NewPos.x2 = NewPos.x2 - MARQUEE_MOVE_STEP;
                UxCtrl_SetPos(&MP3_Menu_RunPanelCtrl, NewPos);
                if(g_uiSongMarqueeTimerID == NULL_TIMER)
                {
                    g_uiSongMarqueeTimerID = KeyScan_startTimer(SONG_MARQUEE_TIME, NVTEVT_MARQUEE_TIMER, ONE_SHOT);
                }
                g_uiMarqueeMoveCnt ++;
                if(uiMoveOffset <= (MARQUEE_MOVE_STEP * g_uiMarqueeMoveCnt))
                    g_uiMarqueeMoveDir = MARQUEE_MOVE_RIGHT;
            }
            else
            {
                NewPos = UxCtrl_GetPos(&MP3_Menu_RunPanelCtrl);
                NewPos.x1 = NewPos.x1 + MARQUEE_MOVE_STEP;
                NewPos.x2 = NewPos.x2 + MARQUEE_MOVE_STEP;
                UxCtrl_SetPos(&MP3_Menu_RunPanelCtrl, NewPos);
                if(g_uiSongMarqueeTimerID == NULL_TIMER)
                {
                    g_uiSongMarqueeTimerID = KeyScan_startTimer(SONG_MARQUEE_TIME, NVTEVT_MARQUEE_TIMER, ONE_SHOT);
                }
                g_uiMarqueeMoveCnt --;
                if(g_uiMarqueeMoveCnt == 0)
                    g_uiMarqueeMoveDir = MARQUEE_MOVE_LEFT;
            }
            break;
        }

        default:
            break;
    }

    Ux_DefaultEvent(pCtrl,NVTEVT_TIMER,paramNum,paramArray);
    return NVTEVT_CONSUME;
}
INT32 MP3_Main_Menu_OnMP3PlayOneSecond(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    NVTEVT evtSecond;

    evtSecond = paramArray[0];
    debug_ind(("UIFlowWndMP3: OnMP3PlayOneSecond sec = 0x%x\r\n", evtSecond));

    /* Update current playing time */
    g_UIMP3Obj.uiPlayingCurrTime = evtSecond;
    UxCtrl_SetShow(&MP3_Text_PlayTimeCtrl,TRUE);
    UxStatic_SetData(&MP3_Text_PlayTimeCtrl,STATIC_VALUE,Txt_Pointer(UIFlowWndMP3_GetMP3PlayTimeString(g_UIMP3Obj.uiPlayingCurrTime, g_UIMP3Obj.uiPlayingTotalTime)));
    UxCtrl_SetDirty(pCtrl->pParent,TRUE);

    Ux_DefaultEvent(pCtrl,NVTEVT_CB_MP3PLAY_ONESECOND,paramNum,paramArray);
    return NVTEVT_CONSUME;
}
INT32 MP3_Main_Menu_OnMP3PlayFinish(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    BOOL bIsPlayingInThisPage = FALSE;
    UINT32 uiPlayingItemIdInThisPage = 0;
    UINT32 i;

    debug_err(("UIFlowWndMP3: OnMP3PlayFinish\r\n"));
    debug_err(("UIFlowWndMP3: uiPlayMode = %d, uiDisplayCurrNum = %ld, uiPlayingNum = %ld\r\n", g_UIMP3Obj.uiPlayMode, g_UIMP3Obj.uiDisplayCurrNum, g_UIMP3Obj.uiPlayingNum));

    /* Close MP3 play task */
    MP3PlayClose();

    /* Update current playing time */
    g_UIMP3Obj.uiPlayingCurrTime = g_UIMP3Obj.uiPlayingTotalTime;
    UxCtrl_SetShow(&MP3_Text_PlayTimeCtrl,TRUE);
    UxStatic_SetData(&MP3_Text_PlayTimeCtrl,STATIC_VALUE,Txt_Pointer(UIFlowWndMP3_GetMP3PlayTimeString(g_UIMP3Obj.uiPlayingCurrTime, g_UIMP3Obj.uiPlayingTotalTime)));

    if(g_UIMP3Obj.uiTotalNum != 0)
    {
        #if 0
        switch(g_UIMP3Obj.uiPlayMode)
        {
        case MP3_PLAY_REPEAT_ONE:
            g_UIMP3Obj.uiPlayingNum = g_UIMP3Obj.uiPlayingNum;
            MP3PlayFileSys_SetNowOrder(g_UIMP3Obj.uiPlayingNum);
            UIFlowWndMP3_StartMP3Playing(MP3PlayFileSys_GetFileIndex(MP3PlayFileSys_GetNowOrder()));
            break;
        case MP3_PLAY_REPEAT_ALL:
            g_UIMP3Obj.uiPlayingNum = (g_UIMP3Obj.uiPlayingNum+1)%g_UIMP3Obj.uiTotalNum;
            MP3PlayFileSys_SetNowOrder(g_UIMP3Obj.uiPlayingNum);
            UIFlowWndMP3_StartMP3Playing(MP3PlayFileSys_GetFileIndex(MP3PlayFileSys_GetNowOrder()));
            break;
        case MP3_PLAY_ONCE:
            break;
        }
        #endif

        if((g_UIMP3Obj.uiPlayingNum <= g_UIMP3Obj.uiDisplayEndNum) && (g_UIMP3Obj.uiPlayingNum >= g_UIMP3Obj.uiDisplayStartNum))
        {
            bIsPlayingInThisPage = TRUE;
            uiPlayingItemIdInThisPage = g_UIMP3Obj.uiPlayingNum - g_UIMP3Obj.uiDisplayStartNum;
        }

        for(i=0; i<MP3ITEM_NUM_PER_PAGE; i++)
        {
            switch(UxMenu_GetItemData(pCtrl,MP3_Main_Menu_STRID_A1 + i,MNUITM_ICONID))
            {
                case MP3ITEM_ICON_PLAY:
                case MP3ITEM_ICON_PAUSE:
                    if(bIsPlayingInThisPage)
                    {
                        #if 0
                        switch(g_UIMP3Obj.uiPlayMode)
                        {
                        case MP3_PLAY_REPEAT_ONE:
                            UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + i, MNUITM_ICONID, MP3ITEM_ICON_PLAY);
                            break;
                        case MP3_PLAY_REPEAT_ALL:
                            UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + i, MNUITM_ICONID, MP3ITEM_ICON_FILE);
                            break;
                        case MP3_PLAY_ONCE:
                            UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + i, MNUITM_ICONID, MP3ITEM_ICON_STOP);
                            break;
                        }
                        #else
                        UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + i, MNUITM_ICONID, MP3ITEM_ICON_STOP);
                        if(uiPlayingItemIdInThisPage == i)
                        {
                            UxState_SetData(&MP3_Text_PlayCtrl,STATE_CURITEM,MP3_Text_Play_STRID_PLAY);
                        }
                        #endif
                    }
                    else
                    {
                        UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + i, MNUITM_ICONID, MP3ITEM_ICON_FILE);
                    }
                    break;

                case MP3ITEM_ICON_FILE:
                    if(bIsPlayingInThisPage)
                    {
                        if(uiPlayingItemIdInThisPage == i)
                        {
                            UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + i, MNUITM_ICONID, MP3ITEM_ICON_PLAY);
                        }
                    }
                    break;

                case MP3ITEM_ICON_NULL:
                    break;
            }
        }
    }

    UxCtrl_SetDirty(pCtrl->pParent,TRUE);
    Ux_DefaultEvent(pCtrl,NVTEVT_CB_MP3PLAY_FINISH,paramNum,paramArray);
    return NVTEVT_CONSUME;
}
INT32 MP3_Main_Menu_OnBeginCtrl(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    UIScreen ScreenObj = *paramArray;
    GxGfx_SetWindow(((DC**)ScreenObj)[0],gClipping_Menu_Wnd.x1,gClipping_Menu_Wnd.y1,gClipping_Menu_Wnd.x2,gClipping_Menu_Wnd.y1+(gClipping_Menu_Wnd.y2-gClipping_Menu_Wnd.y1)*MP3ITEM_NUM_PER_PAGE);
    return NVTEVT_CONSUME;
}
INT32 MP3_Main_Menu_OnEndCtrl(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    UIScreen ScreenObj = *paramArray;
    GxGfx_SetWindow(((DC**)ScreenObj)[0],0,0,320,240);
    return NVTEVT_CONSUME;
}

//----------------------MP3_Menu_ScrollBarCtrl Event---------------------------
EVENT_BEGIN(MP3_Menu_ScrollBar)
EVENT_END

//---------------------MP3_Menu_PanelCtrl Control List---------------------------
CTRL_LIST_BEGIN(MP3_Menu_Panel)
CTRL_LIST_END

//----------------------MP3_Menu_PanelCtrl Event---------------------------
EVENT_BEGIN(MP3_Menu_Panel)
EVENT_END

//---------------------MP3_Menu_RunPanelCtrl Control List---------------------------
CTRL_LIST_BEGIN(MP3_Menu_RunPanel)
CTRL_LIST_ITEM(MP3_Text_Song)
CTRL_LIST_END

//----------------------MP3_Menu_RunPanelCtrl Event---------------------------
EVENT_BEGIN(MP3_Menu_RunPanel)
EVENT_END

//----------------------MP3_Text_SongCtrl Event---------------------------
INT32 MP3_Text_Song_OnBeginCtrl(VControl *, UINT32, UINT32 *);
INT32 MP3_Text_Song_OnEndCtrl(VControl *, UINT32, UINT32 *);
EVENT_BEGIN(MP3_Text_Song)
EVENT_ITEM(NVTEVT_BEGIN_CTRL,MP3_Text_Song_OnBeginCtrl)
EVENT_ITEM(NVTEVT_END_CTRL,MP3_Text_Song_OnEndCtrl)
EVENT_END
INT32 MP3_Text_Song_OnBeginCtrl(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    UIScreen ScreenObj = *paramArray;
    GxGfx_SetWindow(((DC**)ScreenObj)[0],gClipping_Wnd.x1,gClipping_Wnd.y1,gClipping_Wnd.x2,gClipping_Wnd.y2);
    return NVTEVT_CONSUME;
}
INT32 MP3_Text_Song_OnEndCtrl(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    UIScreen ScreenObj = *paramArray;
    GxGfx_SetWindow(((DC**)ScreenObj)[0],0,0,320,240);
    return NVTEVT_CONSUME;
}

//---------------------MP3_TipsBarCtrl Control List---------------------------
CTRL_LIST_BEGIN(MP3_TipsBar)
CTRL_LIST_END

//----------------------MP3_TipsBarCtrl Event---------------------------
EVENT_BEGIN(MP3_TipsBar)
EVENT_END

//----------------------MP3_Icon_OKCtrl Event---------------------------
EVENT_BEGIN(MP3_Icon_OK)
EVENT_END

//----------------------MP3_Text_PlayCtrl Event---------------------------
EVENT_BEGIN(MP3_Text_Play)
EVENT_END

//----------------------MP3_Text_SelectNumCtrl Event---------------------------
EVENT_BEGIN(MP3_Text_SelectNum)
EVENT_END

//----------------------MP3_Icon_BatteryCtrl Event---------------------------
EVENT_BEGIN(MP3_Icon_Battery)
EVENT_END


//-----------------------------------------------------------------------------
// UIFlowWndMP3 User Functions
//-----------------------------------------------------------------------------
static void UIFlowWndMP3_InitUniCodeFont(void)
{
    UINT8 *pMP3Font = NULL;
    pMP3Font = (UINT8 *)UserPS_InitMP3FontData();
    if(pMP3Font)
    {
        UI_Set_FontTable(FONT_TABLE_1, (FONT* )pMP3Font);
    }
}

static void UIFlowWndMP3_InitUIMP3Obj(void)
{
    UINT32 uiPoolAddr;

    // Get memory for MP3 play task
    get_blk((VP *)&uiPoolAddr, POOL_ID_CAPTURE);
    rel_blk(POOL_ID_CAPTURE, (VP)uiPoolAddr);
    g_UIMP3Obj.uiMP3PlayBufAddr = (uiPoolAddr + POOL_SIZE_CAPTURE - POOL_SIZE_MP3FONT - POOL_SIZE_MP3);

    g_UIMP3Obj.uiTotalNum = MP3PlayFileSys_GetMp3TotalFiles();
    if(g_UIMP3Obj.uiTotalNum >= MP3ITEM_NUM_PER_PAGE)
    {
        g_UIMP3Obj.uiDisplayStartNum = g_UIMP3Obj.uiTotalNum - MP3ITEM_NUM_PER_PAGE;
        g_UIMP3Obj.uiDisplayEndNum   = g_UIMP3Obj.uiTotalNum - 1;
        g_UIMP3Obj.uiDisplayCurrNum   = g_UIMP3Obj.uiTotalNum - 1;
    }
    else if(g_UIMP3Obj.uiTotalNum != 0)
    {
        g_UIMP3Obj.uiDisplayStartNum = 0;
        g_UIMP3Obj.uiDisplayEndNum   = g_UIMP3Obj.uiTotalNum - 1;
        g_UIMP3Obj.uiDisplayCurrNum   = g_UIMP3Obj.uiTotalNum - 1;
    }
    else
    {// = 0
        g_UIMP3Obj.uiDisplayStartNum = 0;
        g_UIMP3Obj.uiDisplayEndNum   = 0;
        g_UIMP3Obj.uiDisplayCurrNum = 0;
    }

    g_UIMP3Obj.uiPlayingNum = 0xFFFFFFFF;

    if(g_UIMP3Obj.uiTotalNum != 0)
    {
        g_UIMP3Obj.uiPlayingCurrTime = 0;
        g_UIMP3Obj.uiPlayingTotalTime = UIFlowWndMP3_GetTotalTimeByOrder(g_UIMP3Obj.uiDisplayCurrNum);
    }

    g_UIMP3Obj.uiPlayMode = MP3_PLAY_ONCE;

    debug_err(("###: uiTotalNum         = %ld\r\n", g_UIMP3Obj.uiTotalNum));
    debug_err(("###: uiDisplayStartNum  = %ld\r\n", g_UIMP3Obj.uiDisplayStartNum));
    debug_err(("###: uiDisplayEndNum    = %ld\r\n", g_UIMP3Obj.uiDisplayEndNum));
    debug_err(("###: uiDisplayCurrNum   = %ld\r\n", g_UIMP3Obj.uiDisplayCurrNum));
    debug_err(("###: uiPlayingNum       = %ld\r\n", g_UIMP3Obj.uiPlayingNum));
    debug_err(("###: uiPlayingCurrTime  = %ld\r\n", g_UIMP3Obj.uiPlayingCurrTime));
    debug_err(("###: uiPlayingTotalTime = %ld\r\n", g_UIMP3Obj.uiPlayingTotalTime));
    debug_err(("###: uiPlayMode         = %ld\r\n", g_UIMP3Obj.uiPlayMode));
}

static void UIFlowWndMP3_UpdateWndInfo(void)
{
    UxState_SetData(&MP3_Icon_BatteryCtrl,STATE_CURITEM,GetBatteryLevel());
    UxCtrl_SetShow(&MP3_Text_PlayCtrl,(g_UIMP3Obj.uiTotalNum > 0)? TRUE:FALSE);
}

static void UIFlowWndMP3_StartMP3Playing(UINT32 uiFileIndex)
{
    UINT32 uiTypeNow;
    MP3PLAYAPI_INITPARAM MP3InitParam;

    MP3PlayFile_SetNowIndexToRead(uiFileIndex);

    uiTypeNow = MP3PlayFileSys_GetType(uiFileIndex);
    if(uiTypeNow != SEARCHTYPE_MP3)
    {
        debug_msg("UIFlowWndMP3: Not MP3 file!\r\n");
        return;
    }

    MP3PlayFile_ReadToNextFile(READFILE_CURR);
    MP3PlayClose();

    MP3InitParam.Mp3PlayBufAddr = (UINT32)(g_UIMP3Obj.uiMP3PlayBufAddr);
    MP3InitParam.Mp3PlayBufSize = (UINT32)POOL_SIZE_MP3;
    MP3InitParam.CallbackFunc = FlowMP3_PlayCB;
    g_UIMP3Obj.uiPlayingCurrTime = 0;
    g_UIMP3Obj.uiPlayingTotalTime = UIFlowWndMP3_GetTotalTimeByOrder(MP3PlayFileSys_GetNowOrder());

    MP3PlayOpen(&MP3InitParam);
    MP3PlayApi_SetDefaultVolume(Get_VolumeValue(Get_VolumeIndex()));
    MP3Play_StartPlaying();
}

static CHAR *UIFlowWndMP3_GetSelectNumString(UINT32 uiCurrDisplayNum, UINT32 uiTotalNum)
{
    sprintf(g_MP3SelectNumStr, "%ld/%ld", uiCurrDisplayNum, uiTotalNum);
    return g_MP3SelectNumStr;
}

static CHAR *UIFlowWndMP3_GetMP3PlayTimeString(UINT32 uiCurrPlayTime, UINT32 uiTotalPlayTime)
{
    sprintf(g_MP3PlayTimeStr, "%02d:%02d:%02d / %02d:%02d:%02d",
        uiCurrPlayTime/3600, (uiCurrPlayTime%3600)/60, (uiCurrPlayTime%3600)%60,
        uiTotalPlayTime/3600, (uiTotalPlayTime%3600)/60, (uiTotalPlayTime%3600)%60);

    return g_MP3PlayTimeStr;
}

static UINT32 UIFlowWndMP3_GetTotalTimeByOrder(UINT32 uiOrder)
{
    UINT32 uiNowOrder, uiTotalSecond;

    MP3PlayFileSys_SetNowOrder(uiOrder);
    uiNowOrder = MP3PlayFileSys_GetNowOrder();
    uiTotalSecond = MP3Play_GetActualPlayingSeconds(uiNowOrder, g_UIMP3Obj.uiMP3PlayBufAddr, POOL_SIZE_MP3);

    return uiTotalSecond;
}

static void UIFlowWndMP3_FillMenuTable(void)
{
    BOOL bIsPlayingInThisPage = FALSE;
    UINT32 uiPlayingItemIdInThisPage = 0;
    UINT32 i;

    if(g_UIMP3Obj.uiTotalNum != 0)
    {
        if((g_UIMP3Obj.uiPlayingNum <= g_UIMP3Obj.uiDisplayEndNum) && (g_UIMP3Obj.uiPlayingNum >= g_UIMP3Obj.uiDisplayStartNum))
        {
            bIsPlayingInThisPage = TRUE;
            uiPlayingItemIdInThisPage = g_UIMP3Obj.uiPlayingNum - g_UIMP3Obj.uiDisplayStartNum;
        }

        /* Get mp3 file name going to show on this menu page */
        for(i=g_UIMP3Obj.uiDisplayStartNum; i<=g_UIMP3Obj.uiDisplayEndNum; i++)
        {
            memset((char *)&g_MenuMP3Item[i-g_UIMP3Obj.uiDisplayStartNum][0], 0x00, MP3_LONGFILENAME_LEN_MAX);
            g_MenuMP3Item[i-g_UIMP3Obj.uiDisplayStartNum][0]=0xFF;
            g_MenuMP3Item[i-g_UIMP3Obj.uiDisplayStartNum][1]=0xFE;
            MP3PlayFileApi_GetLongName(i, (UINT16*)&g_MenuMP3Item[i-g_UIMP3Obj.uiDisplayStartNum][2]);
            if(g_MenuMP3Item[i-g_UIMP3Obj.uiDisplayStartNum][2] == 0)
            {
                MP3PlayFileApi_GetShortName(i, (CHAR*)&g_MenuMP3Item[i-g_UIMP3Obj.uiDisplayStartNum][0]);
            }
        }

        /* Fill in the menu items of this menu page */
        for(i=0; i<MP3ITEM_NUM_PER_PAGE; i++)
        {
            if(i <= (g_UIMP3Obj.uiDisplayEndNum - g_UIMP3Obj.uiDisplayStartNum))
            {
                UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + i, MNUITM_STRID, Txt_Pointer(g_MenuMP3Item[i]));
                if(bIsPlayingInThisPage)
                {
                    if(i == uiPlayingItemIdInThisPage)
                    {
                        if(MP3Play_GetMP3CurrStatus() == MP3PLAY_PLAYING)
                            UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + i, MNUITM_ICONID, MP3ITEM_ICON_PLAY);
                        else if(MP3Play_GetMP3CurrStatus() == MP3PLAY_PAUSE)
                            UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + i, MNUITM_ICONID, MP3ITEM_ICON_PAUSE);
                        else
                            UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + i, MNUITM_ICONID, MP3ITEM_ICON_STOP);
                    }
                    else
                    {
                        UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + i, MNUITM_ICONID, MP3ITEM_ICON_FILE);
                    }
                }
                else
                {
                    UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + i, MNUITM_ICONID, MP3ITEM_ICON_FILE);
                }
                UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + i, MNUITM_STATUS, STATUS_ENABLE);
            }
            else
            {
                sprintf(g_MenuMP3Item[i], "");
                UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + i, MNUITM_STRID, Txt_Pointer(g_MenuMP3Item[i]));
                UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + i, MNUITM_ICONID, MP3ITEM_ICON_NULL);
                UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + i, MNUITM_STATUS, STATUS_DISABLE);
            }
        }
    }
    else
    {
        for(i=0; i<MP3ITEM_NUM_PER_PAGE; i++)
        {
            sprintf(g_MenuMP3Item[i], "");
            UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + i, MNUITM_STRID, Txt_Pointer(g_MenuMP3Item[i]));
            UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + i, MNUITM_ICONID, MP3ITEM_ICON_NULL);
            UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + i, MNUITM_STATUS, STATUS_DISABLE);
        }
    }
}

static void UIFlowWndMP3_StartSongMarquee(void)
{
    UINT32 uiCurrMenuItem;

    uiCurrMenuItem =  UxMenu_GetData(&MP3_Main_MenuCtrl,MNU_CURITM);
    gClipping_Wnd_default = UxCtrl_GetPos(&MP3_Menu_RunPanelCtrl);//original pos
    UxCtrl_SetPos(&MP3_Menu_RunPanelCtrl, gClipping_Wnd_item[uiCurrMenuItem]);
    gClipping_Wnd = UxCtrl_GetPos(&MP3_Menu_RunPanelCtrl);//original pos
    gClipping_Menu_Wnd = UxCtrl_GetPos(&MP3_Main_MenuCtrl);//original menu pos

    UxMenu_SetItemData(&MP3_Main_MenuCtrl, MP3_Main_Menu_STRID_A1 + uiCurrMenuItem, MNUITM_STRID, Txt_Pointer(""));
    GxGfx_Text(0, 0, 0, g_MenuMP3Item[uiCurrMenuItem]);
    g_SongStrSize = GxGfx_GetTextLastSize();
    UxStatic_SetData(&MP3_Text_SongCtrl,STATIC_VALUE,Txt_Pointer(g_MenuMP3Item[uiCurrMenuItem]));
    debug_err(("UIFlowWndMP3: g_SongStrSize.w = %d\n\r", g_SongStrSize.w));

    if((g_UIMP3Obj.uiTotalNum != 0) && (g_SongStrSize.w > (gClipping_Wnd_item[0].x2 - gClipping_Wnd_item[0].x1 - 1)))
    {
        if(g_uiSongMarqueeTimerID == NULL_TIMER)
        {
            g_uiSongMarqueeTimerID = KeyScan_startTimer(SONG_MARQUEE_TIME, NVTEVT_MARQUEE_TIMER, ONE_SHOT);
        }
    }
}


